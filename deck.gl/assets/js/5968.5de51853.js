"use strict";(self.webpackChunkproject_website=self.webpackChunkproject_website||[]).push([[5968],{26921:(t,e,i)=>{i.d(e,{u:()=>Wt});var r=i(74152),s=i(61439);const n="4.1.4",o={COMPOSITE:"cmpt",POINT_CLOUD:"pnts",BATCHED_3D_MODEL:"b3dm",INSTANCED_3D_MODEL:"i3dm",GEOMETRY:"geom",VECTOR:"vect",GLTF:"glTF"};Object.keys(o);var a=i(56709);function l(t,e,i){(0,a.h)(t instanceof ArrayBuffer);const r=new TextDecoder("utf8"),s=new Uint8Array(t,e,i);return r.decode(s)}var h=i(17935),c=i(34707),u=i(2634),d=i(51394);const p={[u.I6.DOUBLE]:Float64Array,[u.I6.FLOAT]:Float32Array,[u.I6.UNSIGNED_SHORT]:Uint16Array,[u.I6.UNSIGNED_INT]:Uint32Array,[u.I6.UNSIGNED_BYTE]:Uint8Array,[u.I6.BYTE]:Int8Array,[u.I6.SHORT]:Int16Array,[u.I6.INT]:Int32Array},f={DOUBLE:u.I6.DOUBLE,FLOAT:u.I6.FLOAT,UNSIGNED_SHORT:u.I6.UNSIGNED_SHORT,UNSIGNED_INT:u.I6.UNSIGNED_INT,UNSIGNED_BYTE:u.I6.UNSIGNED_BYTE,BYTE:u.I6.BYTE,SHORT:u.I6.SHORT,INT:u.I6.INT},m="Failed to convert GL type";class y{static fromTypedArray(t){t=ArrayBuffer.isView(t)?t.constructor:t;for(const e in p){if(p[e]===t)return e}throw new Error(m)}static fromName(t){const e=f[t];if(!e)throw new Error(m);return e}static getArrayType(t){switch(t){case u.I6.UNSIGNED_SHORT_5_6_5:case u.I6.UNSIGNED_SHORT_4_4_4_4:case u.I6.UNSIGNED_SHORT_5_5_5_1:return Uint16Array;default:const e=p[t];if(!e)throw new Error(m);return e}}static getByteSize(t){return y.getArrayType(t).BYTES_PER_ELEMENT}static validate(t){return Boolean(y.getArrayType(t))}static createTypedArray(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3?arguments[3]:void 0;void 0===r&&(r=(e.byteLength-i)/y.getByteSize(t));return new(y.getArrayType(t))(e,i,r)}}class g{constructor(t,e){this.json=void 0,this.buffer=void 0,this.featuresLength=0,this._cachedTypedArrays={},this.json=t,this.buffer=e}getExtension(t){return this.json.extensions&&this.json.extensions[t]}hasProperty(t){return Boolean(this.json[t])}getGlobalProperty(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:u.GL.UNSIGNED_INT,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;const r=this.json[t];return r&&Number.isFinite(r.byteOffset)?this._getTypedArrayFromBinary(t,e,i,1,r.byteOffset):r}getPropertyArray(t,e,i){const r=this.json[t];return r&&Number.isFinite(r.byteOffset)?("componentType"in r&&(e=y.fromName(r.componentType)),this._getTypedArrayFromBinary(t,e,i,this.featuresLength,r.byteOffset)):this._getTypedArrayFromArray(t,e,r)}getProperty(t,e,i,r,s){const n=this.json[t];if(!n)return n;const o=this.getPropertyArray(t,e,i);if(1===i)return o[r];for(let a=0;a<i;++a)s[a]=o[i*r+a];return s}_getTypedArrayFromBinary(t,e,i,r,s){const n=this._cachedTypedArrays;let o=n[t];return o||(o=y.createTypedArray(e,this.buffer.buffer,this.buffer.byteOffset+s,r*i),n[t]=o),o}_getTypedArrayFromArray(t,e,i){const r=this._cachedTypedArrays;let s=r[t];return s||(s=y.createTypedArray(e,i),r[t]=s),s}}const T={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},_={SCALAR:(t,e)=>t[e],VEC2:(t,e)=>[t[2*e+0],t[2*e+1]],VEC3:(t,e)=>[t[3*e+0],t[3*e+1],t[3*e+2]],VEC4:(t,e)=>[t[4*e+0],t[4*e+1],t[4*e+2],t[4*e+3]],MAT2:(t,e)=>[t[4*e+0],t[4*e+1],t[4*e+2],t[4*e+3]],MAT3:(t,e)=>[t[9*e+0],t[9*e+1],t[9*e+2],t[9*e+3],t[9*e+4],t[9*e+5],t[9*e+6],t[9*e+7],t[9*e+8]],MAT4:(t,e)=>[t[16*e+0],t[16*e+1],t[16*e+2],t[16*e+3],t[16*e+4],t[16*e+5],t[16*e+6],t[16*e+7],t[16*e+8],t[16*e+9],t[16*e+10],t[16*e+11],t[16*e+12],t[16*e+13],t[16*e+14],t[16*e+15]]},b={SCALAR:(t,e,i)=>{e[i]=t},VEC2:(t,e,i)=>{e[2*i+0]=t[0],e[2*i+1]=t[1]},VEC3:(t,e,i)=>{e[3*i+0]=t[0],e[3*i+1]=t[1],e[3*i+2]=t[2]},VEC4:(t,e,i)=>{e[4*i+0]=t[0],e[4*i+1]=t[1],e[4*i+2]=t[2],e[4*i+3]=t[3]},MAT2:(t,e,i)=>{e[4*i+0]=t[0],e[4*i+1]=t[1],e[4*i+2]=t[2],e[4*i+3]=t[3]},MAT3:(t,e,i)=>{e[9*i+0]=t[0],e[9*i+1]=t[1],e[9*i+2]=t[2],e[9*i+3]=t[3],e[9*i+4]=t[4],e[9*i+5]=t[5],e[9*i+6]=t[6],e[9*i+7]=t[7],e[9*i+8]=t[8],e[9*i+9]=t[9]},MAT4:(t,e,i)=>{e[16*i+0]=t[0],e[16*i+1]=t[1],e[16*i+2]=t[2],e[16*i+3]=t[3],e[16*i+4]=t[4],e[16*i+5]=t[5],e[16*i+6]=t[6],e[16*i+7]=t[7],e[16*i+8]=t[8],e[16*i+9]=t[9],e[16*i+10]=t[10],e[16*i+11]=t[11],e[16*i+12]=t[12],e[16*i+13]=t[13],e[16*i+14]=t[14],e[16*i+15]=t[15]}};const w=t=>void 0!==t;function v(t,e,i){if(!e)return null;let r=t.getExtension("3DTILES_batch_table_hierarchy");const s=e.HIERARCHY;return s&&(console.warn("3D Tile Parser: HIERARCHY is deprecated. Use 3DTILES_batch_table_hierarchy."),e.extensions=e.extensions||{},e.extensions["3DTILES_batch_table_hierarchy"]=s,r=s),r?function(t,e){let i,r,s;const n=t.instancesLength,o=t.classes;let a,l=t.classIds,h=t.parentCounts,c=t.parentIds,u=n;w(l.byteOffset)&&(l.componentType=defaultValue(l.componentType,GL.UNSIGNED_SHORT),l.type=AttributeType.SCALAR,s=getBinaryAccessor(l),l=s.createArrayBufferView(e.buffer,e.byteOffset+l.byteOffset,n));if(w(h))for(w(h.byteOffset)&&(h.componentType=defaultValue(h.componentType,GL.UNSIGNED_SHORT),h.type=AttributeType.SCALAR,s=getBinaryAccessor(h),h=s.createArrayBufferView(e.buffer,e.byteOffset+h.byteOffset,n)),a=new Uint16Array(n),u=0,i=0;i<n;++i)a[i]=u,u+=h[i];w(c)&&w(c.byteOffset)&&(c.componentType=defaultValue(c.componentType,GL.UNSIGNED_SHORT),c.type=AttributeType.SCALAR,s=getBinaryAccessor(c),c=s.createArrayBufferView(e.buffer,e.byteOffset+c.byteOffset,u));const d=o.length;for(i=0;i<d;++i){const t=o[i].length,r=o[i].instances,s=getBinaryProperties(t,r,e);o[i].instances=combine(s,r)}const p=new Array(d).fill(0),f=new Uint16Array(n);for(i=0;i<n;++i)r=l[i],f[i]=p[r],++p[r];const m={classes:o,classIds:l,classIndexes:f,parentCounts:h,parentIndexes:a,parentIds:c};return function(t){const e=t.classIds,i=e.length;for(let r=0;r<i;++r)E(t,r,stack)}(m),m}(r,i):null}function S(t,e,i){if(!t)return;const r=t.parentCounts;return t.parentIds?i(t,e):r>0?function(t,e,i){const r=t.classIds,s=t.parentCounts,n=t.parentIds,o=t.parentIndexes,a=r.length,l=scratchVisited;l.length=Math.max(l.length,a);const h=++marker,c=scratchStack;c.length=0,c.push(e);for(;c.length>0;){if(l[e=c.pop()]===h)continue;l[e]=h;const r=i(t,e);if(w(r))return r;const a=s[e],u=o[e];for(let t=0;t<a;++t){const i=n[u+t];i!==e&&c.push(i)}}return null}(t,e,i):function(t,e,i){let r=!0;for(;r;){const s=i(t,e);if(w(s))return s;const n=t.parentIds[e];r=n!==e,e=n}throw new Error("traverseHierarchySingleParent")}(t,e,i)}function E(t,e,i){const r=t.parentCounts,s=t.parentIds,n=t.parentIndexes,o=t.classIds.length;if(!w(s))return;assert(e<o,`Parent index ${e} exceeds the total number of instances: ${o}`),assert(-1===i.indexOf(e),"Circular dependency detected in the batch table hierarchy."),i.push(e);const a=w(r)?r[e]:1,l=w(r)?n[e]:e;for(let h=0;h<a;++h){const r=s[l+h];r!==e&&E(t,r,i)}i.pop(e)}function P(t){return null!=t}const I=(t,e)=>t,A={HIERARCHY:!0,extensions:!0,extras:!0};class O{constructor(t,e,i){var r;let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};this.json=void 0,this.binary=void 0,this.featureCount=void 0,this._extensions=void 0,this._properties=void 0,this._binaryProperties=void 0,this._hierarchy=void 0,(0,a.h)(i>=0),this.json=t||{},this.binary=e,this.featureCount=i,this._extensions=(null===(r=this.json)||void 0===r?void 0:r.extensions)||{},this._properties={};for(const n in this.json)A[n]||(this._properties[n]=this.json[n]);this._binaryProperties=this._initializeBinaryProperties(),s["3DTILES_batch_table_hierarchy"]&&(this._hierarchy=v(this,this.json,this.binary))}getExtension(t){return this.json&&this.json.extensions&&this.json.extensions[t]}memorySizeInBytes(){return 0}isClass(t,e){if(this._checkBatchId(t),(0,a.h)("string"==typeof e,e),this._hierarchy){return P(S(this._hierarchy,t,((t,i)=>{const r=t.classIds[i];return t.classes[r].name===e})))}return!1}isExactClass(t,e){return(0,a.h)("string"==typeof e,e),this.getExactClassName(t)===e}getExactClassName(t){if(this._checkBatchId(t),this._hierarchy){const e=this._hierarchy.classIds[t];return this._hierarchy.classes[e].name}}hasProperty(t,e){return this._checkBatchId(t),(0,a.h)("string"==typeof e,e),P(this._properties[e])||this._hasPropertyInHierarchy(t,e)}getPropertyNames(t,e){this._checkBatchId(t),(e=P(e)?e:[]).length=0;const i=Object.keys(this._properties);return e.push(...i),this._hierarchy&&this._getPropertyNamesInHierarchy(t,e),e}getProperty(t,e){if(this._checkBatchId(t),(0,a.h)("string"==typeof e,e),this._binaryProperties){const i=this._binaryProperties[e];if(P(i))return this._getBinaryProperty(i,t)}const i=this._properties[e];if(P(i))return I(i[t]);if(this._hierarchy){const i=this._getHierarchyProperty(t,e);if(P(i))return i}}setProperty(t,e,i){const r=this.featureCount;if(this._checkBatchId(t),(0,a.h)("string"==typeof e,e),this._binaryProperties){const r=this._binaryProperties[e];if(r)return void this._setBinaryProperty(r,t,i)}if(this._hierarchy&&this._setHierarchyProperty(this,t,e,i))return;let s=this._properties[e];P(s)||(this._properties[e]=new Array(r),s=this._properties[e]),s[t]=I(i)}_checkBatchId(t){if(!(t>=0&&t<this.featureCount))throw new Error("batchId not in range [0, featureCount - 1].")}_getBinaryProperty(t,e){return t.unpack(t.typedArray,e)}_setBinaryProperty(t,e,i){t.pack(i,t.typedArray,e)}_initializeBinaryProperties(){let t=null;for(const e in this._properties){const i=this._properties[e],r=this._initializeBinaryProperty(e,i);r&&(t=t||{},t[e]=r)}return t}_initializeBinaryProperty(t,e){if("byteOffset"in e){const i=e;(0,a.h)(this.binary,`Property ${t} requires a batch table binary.`),(0,a.h)(i.type,`Property ${t} requires a type.`);const r=function(t,e,i,r){const{componentType:s}=t;(0,a.h)(t.componentType);const n="string"==typeof s?y.fromName(s):s,o=T[t.type],l=_[t.type],h=b[t.type];return i+=t.byteOffset,{values:y.createTypedArray(n,e,i,o*r),type:n,size:o,unpacker:l,packer:h}}(i,this.binary.buffer,0|this.binary.byteOffset,this.featureCount);return{typedArray:r.values,componentCount:r.size,unpack:r.unpacker,pack:r.packer}}return null}_hasPropertyInHierarchy(t,e){if(!this._hierarchy)return!1;const i=S(this._hierarchy,t,((t,i)=>{const r=t.classIds[i];return P(t.classes[r].instances[e])}));return P(i)}_getPropertyNamesInHierarchy(t,e){S(this._hierarchy,t,((t,i)=>{const r=t.classIds[i],s=t.classes[r].instances;for(const n in s)s.hasOwnProperty(n)&&-1===e.indexOf(n)&&e.push(n)}))}_getHierarchyProperty(t,e){return S(this._hierarchy,t,((t,i)=>{const r=t.classIds[i],s=t.classes[r],n=t.classIndexes[i],o=s.instances[e];return P(o)?P(o.typedArray)?this._getBinaryProperty(o,n):I(o[n]):null}))}_setHierarchyProperty(t,e,i,r){const s=S(this._hierarchy,e,((t,s)=>{const n=t.classIds[s],o=t.classes[n],l=t.classIndexes[s],h=o.instances[i];return!!P(h)&&((0,a.h)(s===e,`Inherited property "${i}" is read-only.`),P(h.typedArray)?this._setBinaryProperty(h,l,r):h[l]=I(r),!0)}));return P(s)}}const N=4;function C(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const r=new DataView(e);if(t.magic=r.getUint32(i,!0),i+=N,t.version=r.getUint32(i,!0),i+=N,t.byteLength=r.getUint32(i,!0),i+=N,1!==t.version)throw new Error(`3D Tile Version ${t.version} not supported`);return i}const M=4,x="b3dm tile in legacy format.";function L(t,e,i){const r=new DataView(e);let s;t.header=t.header||{};let n=r.getUint32(i,!0);i+=M;let o=r.getUint32(i,!0);i+=M;let a=r.getUint32(i,!0);i+=M;let l=r.getUint32(i,!0);return i+=M,a>=570425344?(i-=2*M,s=n,a=o,l=0,n=0,o=0,console.warn(x)):l>=570425344&&(i-=M,s=a,a=n,l=o,n=0,o=0,console.warn(x)),t.header.featureTableJsonByteLength=n,t.header.featureTableBinaryByteLength=o,t.header.batchTableJsonByteLength=a,t.header.batchTableBinaryByteLength=l,t.header.batchLength=s,i}function R(t,e,i,r){return i=function(t,e,i,r){const{featureTableJsonByteLength:s,featureTableBinaryByteLength:n,batchLength:o}=t.header||{};if(t.featureTableJson={BATCH_LENGTH:o||0},s&&s>0){const r=l(e,i,s);t.featureTableJson=JSON.parse(r)}return i+=s||0,t.featureTableBinary=new Uint8Array(e,i,n),i+=n||0,i}(t,e,i),i=function(t,e,i,r){const{batchTableJsonByteLength:s,batchTableBinaryByteLength:n}=t.header||{};if(s&&s>0){const r=l(e,i,s);t.batchTableJson=JSON.parse(r),i+=s,n&&n>0&&(t.batchTableBinary=new Uint8Array(e,i,n),t.batchTableBinary=new Uint8Array(t.batchTableBinary),i+=n)}return i}(t,e,i),i}function U(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,0,0];const i=t>>11&31,r=t>>5&63,s=31&t;return e[0]=i<<3,e[1]=r<<2,e[2]=s<<3,e}function D(t,e,i){if(!(e||t&&t.batchIds&&i))return null;const{batchIds:r,isRGB565:s,pointCount:n=0}=t;if(r&&i){const t=new Uint8ClampedArray(3*n);for(let e=0;e<n;e++){const s=r[e],n=i.getProperty(s,"dimensions").map((t=>255*t));t[3*e]=n[0],t[3*e+1]=n[1],t[3*e+2]=n[2]}return{type:u.GL.UNSIGNED_BYTE,value:t,size:3,normalized:!0}}if(e&&s){const t=new Uint8ClampedArray(3*n);for(let i=0;i<n;i++){const r=U(e[i]);t[3*i]=r[0],t[3*i+1]=r[1],t[3*i+2]=r[2]}return{type:u.GL.UNSIGNED_BYTE,value:t,size:3,normalized:!0}}return e&&e.length===3*n?{type:u.GL.UNSIGNED_BYTE,value:e,size:3,normalized:!0}:{type:u.GL.UNSIGNED_BYTE,value:e||new Uint8ClampedArray,size:4,normalized:!0}}var B=i(72969),V=i(55715);new B.F,new d.P,new B.F,new B.F,new Uint8Array(1);function G(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:255;return(0,V.uZ)(t,0,e)/e*2-1}function z(t){return t<0?-1:1}function F(t,e,i,r){if(function(t,e){if(!t)throw new Error(`math.gl assertion failed. ${e}`)}(r),t<0||t>i||e<0||e>i)throw new Error(`x and y must be unsigned normalized integers between 0 and ${i}`);if(r.x=G(t,i),r.y=G(e,i),r.z=1-(Math.abs(r.x)+Math.abs(r.y)),r.z<0){const t=r.x;r.x=(1-Math.abs(r.y))*z(t),r.y=(1-Math.abs(t))*z(r.y)}return r.normalize()}function q(t,e,i){return F(t,e,255,i)}const H=new d.P;function k(t,e,i){return t.isQuantized?i["3d-tiles"]&&i["3d-tiles"].decodeQuantizedPositions?(t.isQuantized=!1,function(t,e){const i=new d.P,r=new Float32Array(3*t.pointCount);for(let s=0;s<t.pointCount;s++)i.set(e[3*s],e[3*s+1],e[3*s+2]).scale(1/t.quantizedRange).multiply(t.quantizedVolumeScale).add(t.quantizedVolumeOffset).toArray(r,3*s);return r}(t,e)):{type:u.GL.UNSIGNED_SHORT,value:e,size:3,normalized:!0}:e}async function j(t,e,i,r,s){i=R(t,e,i=L(t,e,i=C(t,e,i))),function(t){t.attributes={positions:null,colors:null,normals:null,batchIds:null},t.isQuantized=!1,t.isTranslucent=!1,t.isRGB565=!1,t.isOctEncoded16P=!1}(t);const{featureTable:n,batchTable:o}=function(t){const e=new g(t.featureTableJson,t.featureTableBinary),i=e.getGlobalProperty("POINTS_LENGTH");if(!Number.isFinite(i))throw new Error("POINTS_LENGTH must be defined");e.featuresLength=i,t.featuresLength=i,t.pointsLength=i,t.pointCount=i,t.rtcCenter=e.getGlobalProperty("RTC_CENTER",u.GL.FLOAT,3);const r=function(t,e){let i=null;if(!t.batchIds&&e.hasProperty("BATCH_ID")&&(t.batchIds=e.getPropertyArray("BATCH_ID",u.GL.UNSIGNED_SHORT,1),t.batchIds)){const r=e.getGlobalProperty("BATCH_LENGTH");if(!r)throw new Error("Global property: BATCH_LENGTH must be defined when BATCH_ID is defined.");const{batchTableJson:s,batchTableBinary:n}=t;i=new O(s,n,r)}return i}(t,e);return{featureTable:e,batchTable:r}}(t);return await async function(t,e,i,r,s){let n,o,a;const l=t.batchTableJson&&t.batchTableJson.extensions&&t.batchTableJson.extensions["3DTILES_draco_point_compression"];l&&(a=l.properties);const u=e.getExtension("3DTILES_draco_point_compression");if(u){o=u.properties;const e=u.byteOffset,i=u.byteLength;if(!o||!Number.isFinite(e)||!i)throw new Error("Draco properties, byteOffset, and byteLength must be defined");n=(t.featureTableBinary||[]).slice(e,e+i),t.hasPositions=Number.isFinite(o.POSITION),t.hasColors=Number.isFinite(o.RGB)||Number.isFinite(o.RGBA),t.hasNormals=Number.isFinite(o.NORMAL),t.hasBatchIds=Number.isFinite(o.BATCH_ID),t.isTranslucent=Number.isFinite(o.RGBA)}if(!n)return!0;const p={buffer:n,properties:{...o,...a},featureTableProperties:o,batchTableProperties:a,dequantizeInShader:!1};return await async function(t,e,i,r){if(!r)return;const s={...i,draco:{...null==i?void 0:i.draco,extraAttributes:e.batchTableProperties||{}}};delete s["3d-tiles"];const n=await(0,c.cr)(e.buffer,h.VJ,s,r),o=n.attributes.POSITION&&n.attributes.POSITION.value,a=n.attributes.COLOR_0&&n.attributes.COLOR_0.value,l=n.attributes.NORMAL&&n.attributes.NORMAL.value,u=n.attributes.BATCH_ID&&n.attributes.BATCH_ID.value,p=o&&n.attributes.POSITION.value.quantization,f=l&&n.attributes.NORMAL.value.quantization;if(p){const e=n.POSITION.data.quantization,i=e.range;t.quantizedVolumeScale=new d.P(i,i,i),t.quantizedVolumeOffset=new d.P(e.minValues),t.quantizedRange=(1<<e.quantizationBits)-1,t.isQuantizedDraco=!0}f&&(t.octEncodedRange=(1<<n.NORMAL.data.quantization.quantizationBits)-1,t.isOctEncodedDraco=!0);const m={};if(e.batchTableProperties)for(const h of Object.keys(e.batchTableProperties))n.attributes[h]&&n.attributes[h].value&&(m[h.toLowerCase()]=n.attributes[h].value);t.attributes={positions:o,colors:D(t,a,void 0),normals:l,batchIds:u,...m}}(t,p,r,s)}(t,n,0,r,s),function(t,e,i){if(t.attributes=t.attributes||{positions:null,colors:null,normals:null,batchIds:null},!t.attributes.positions)if(e.hasProperty("POSITION"))t.attributes.positions=e.getPropertyArray("POSITION",u.GL.FLOAT,3);else if(e.hasProperty("POSITION_QUANTIZED")){const r=e.getPropertyArray("POSITION_QUANTIZED",u.GL.UNSIGNED_SHORT,3);if(t.isQuantized=!0,t.quantizedRange=65535,t.quantizedVolumeScale=e.getGlobalProperty("QUANTIZED_VOLUME_SCALE",u.GL.FLOAT,3),!t.quantizedVolumeScale)throw new Error("QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");if(t.quantizedVolumeOffset=e.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",u.GL.FLOAT,3),!t.quantizedVolumeOffset)throw new Error("QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");t.attributes.positions=k(t,r,i)}if(!t.attributes.positions)throw new Error("Either POSITION or POSITION_QUANTIZED must be defined.")}(t,n,r),function(t,e,i){if(t.attributes=t.attributes||{positions:null,colors:null,normals:null,batchIds:null},!t.attributes.colors){let r=null;e.hasProperty("RGBA")?(r=e.getPropertyArray("RGBA",u.GL.UNSIGNED_BYTE,4),t.isTranslucent=!0):e.hasProperty("RGB")?r=e.getPropertyArray("RGB",u.GL.UNSIGNED_BYTE,3):e.hasProperty("RGB565")&&(r=e.getPropertyArray("RGB565",u.GL.UNSIGNED_SHORT,1),t.isRGB565=!0),t.attributes.colors=D(t,r,i)}e.hasProperty("CONSTANT_RGBA")&&(t.constantRGBA=e.getGlobalProperty("CONSTANT_RGBA",u.GL.UNSIGNED_BYTE,4))}(t,n,o),function(t,e){if(t.attributes=t.attributes||{positions:null,colors:null,normals:null,batchIds:null},!t.attributes.normals){let i=null;e.hasProperty("NORMAL")?i=e.getPropertyArray("NORMAL",u.GL.FLOAT,3):e.hasProperty("NORMAL_OCT16P")&&(i=e.getPropertyArray("NORMAL_OCT16P",u.GL.UNSIGNED_BYTE,2),t.isOctEncoded16P=!0),t.attributes.normals=function(t,e){if(!e)return null;if(t.isOctEncoded16P){const i=new Float32Array(3*(t.pointsLength||0));for(let r=0;r<(t.pointsLength||0);r++)q(e[2*r],e[2*r+1],H),H.toArray(i,3*r);return{type:u.GL.FLOAT,size:2,value:i}}return{type:u.GL.FLOAT,size:2,value:e}}(t,i)}}(t,n),i}var $=i(52977),W=i(91913),Q=i(50027),Z=i(27583);const Y={URI:0,EMBEDDED:1};function J(t,e,i,r){t.rotateYtoZ=!0;const s=(t.byteOffset||0)+(t.byteLength||0)-i;if(0===s)throw new Error("glTF byte length must be greater than 0.");return t.gltfUpAxis=null!=r&&r["3d-tiles"]&&r["3d-tiles"].assetGltfUpAxis?r["3d-tiles"].assetGltfUpAxis:"Y",t.gltfArrayBuffer=(0,Z.qv)(e,i,s),t.gltfByteOffset=0,t.gltfByteLength=s,i%4==0||console.warn(`${t.type}: embedded glb is not aligned to a 4-byte boundary.`),(t.byteOffset||0)+(t.byteLength||0)}async function X(t,e,i,r){const s=(null==i?void 0:i["3d-tiles"])||{};if(function(t,e,i){switch(e){case Y.URI:if(t.gltfArrayBuffer){const e=new Uint8Array(t.gltfArrayBuffer,t.gltfByteOffset),i=(new TextDecoder).decode(e);t.gltfUrl=i.replace(/[\s\0]+$/,"")}delete t.gltfArrayBuffer,delete t.gltfByteOffset,delete t.gltfByteLength;break;case Y.EMBEDDED:break;default:throw new Error("b3dm: Illegal glTF format field")}}(t,e),s.loadGLTF){if(!r)return;if(t.gltfUrl){const{fetch:e}=r,s=await e(t.gltfUrl,i);t.gltfArrayBuffer=await s.arrayBuffer(),t.gltfByteOffset=0}if(t.gltfArrayBuffer){const e=await(0,c.cr)(t.gltfArrayBuffer,$.E,i,r);t.gltf=(0,W.w)(e),t.gpuMemoryUsageInBytes=(0,Q.Xr)(t.gltf),delete t.gltfArrayBuffer,delete t.gltfByteOffset,delete t.gltfByteLength}}}async function K(t,e,i,r,s){var n;i=function(t,e,i,r,s){i=C(t,e,i),i=L(t,e,i),i=R(t,e,i),i=J(t,e,i,r);const n=new g(t.featureTableJson,t.featureTableBinary);return t.rtcCenter=n.getGlobalProperty("RTC_CENTER",u.GL.FLOAT,3),i}(t,e,i,r),await X(t,Y.EMBEDDED,r,s);const o=null==t||null===(n=t.gltf)||void 0===n?void 0:n.extensions;return o&&o.CESIUM_RTC&&(t.rtcCenter=o.CESIUM_RTC.center),i}var tt=i(57588),et=i(72889),it=i(84900),rt=i(99313);async function st(t,e,i,r,s){return i=function(t,e,i,r,s){var n;if(i=C(t,e,i),1!==t.version)throw new Error(`Instanced 3D Model version ${t.version} is not supported`);i=L(t,e,i);const o=new DataView(e);if(t.gltfFormat=o.getUint32(i,!0),i+=4,i=R(t,e,i),i=J(t,e,i,r),!(null!=t&&null!==(n=t.header)&&void 0!==n&&n.featureTableJsonByteLength)||0===t.header.featureTableJsonByteLength)throw new Error("i3dm parser: featureTableJsonByteLength is zero.");const a=new g(t.featureTableJson,t.featureTableBinary),l=a.getGlobalProperty("INSTANCES_LENGTH");if(a.featuresLength=l,!Number.isFinite(l))throw new Error("i3dm parser: INSTANCES_LENGTH must be defined");t.eastNorthUp=a.getGlobalProperty("EAST_NORTH_UP"),t.rtcCenter=a.getGlobalProperty("RTC_CENTER",u.GL.FLOAT,3);new O(t.batchTableJson,t.batchTableBinary,l);return function(t,e,i,r){const s=new Array(r),n=new d.P,o=new d.P,a=new d.P,l=new d.P,h=new tt.V,c=new et._,p=new d.P,f={},m=new it.y,y=[],g=[],T=[],_=[];for(let d=0;d<r;d++){let i;if(e.hasProperty("POSITION"))i=e.getProperty("POSITION",u.GL.FLOAT,3,d,n);else if(e.hasProperty("POSITION_QUANTIZED")){i=e.getProperty("POSITION_QUANTIZED",u.GL.UNSIGNED_SHORT,3,d,n);const t=e.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",u.GL.FLOAT,3);if(!t)throw new Error("i3dm parser: QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");const r=e.getGlobalProperty("QUANTIZED_VOLUME_SCALE",u.GL.FLOAT,3);if(!r)throw new Error("i3dm parser: QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");const s=65535;for(let e=0;e<3;e++)i[e]=i[e]/s*r[e]+t[e]}if(!i)throw new Error("i3dm: POSITION or POSITION_QUANTIZED must be defined for each instance.");n.copy(i),f.translation=n,t.normalUp=e.getProperty("NORMAL_UP",u.GL.FLOAT,3,d,y),t.normalRight=e.getProperty("NORMAL_RIGHT",u.GL.FLOAT,3,d,g);const r=!1;if(t.normalUp){if(!t.normalRight)throw new Error("i3dm: Custom orientation requires both NORMAL_UP and NORMAL_RIGHT.");t.hasCustomOrientation=!0}else{if(t.octNormalUp=e.getProperty("NORMAL_UP_OCT32P",u.GL.UNSIGNED_SHORT,2,d,y),t.octNormalRight=e.getProperty("NORMAL_RIGHT_OCT32P",u.GL.UNSIGNED_SHORT,2,d,g),t.octNormalUp){if(!t.octNormalRight)throw new Error("i3dm: oct-encoded orientation requires NORMAL_UP_OCT32P and NORMAL_RIGHT_OCT32P");throw new Error("i3dm: oct-encoded orientation not implemented")}t.eastNorthUp?(rt.H.WGS84.eastNorthUpToFixedFrame(n,m),m.getRotationMatrix3(h)):h.identity()}r&&(l.copy(o).cross(a).normalize(),h.setColumn(0,o),h.setColumn(1,a),h.setColumn(2,l)),c.fromMatrix3(h),f.rotation=c,p.set(1,1,1);const b=e.getProperty("SCALE",u.GL.FLOAT,1,d,T);Number.isFinite(b)&&p.multiplyByScalar(b);const w=e.getProperty("SCALE_NON_UNIFORM",u.GL.FLOAT,3,d,y);w&&p.scale(w),f.scale=p;let v=e.getProperty("BATCH_ID",u.GL.UNSIGNED_SHORT,1,d,_);void 0===v&&(v=d);const S=(new it.y).fromQuaternion(f.rotation);m.identity(),m.translate(f.translation),m.multiplyRight(S),m.scale(f.scale);const E=m.clone();s[d]={modelMatrix:E,batchId:v}}t.instances=s}(t,a,0,l),i}(t,e,i,r),await X(t,t.gltfFormat||0,r,s),i}async function nt(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{shape:"tile3d"};switch(s.byteOffset=e,s.type=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const i=new DataView(t);return`${String.fromCharCode(i.getUint8(e+0))}${String.fromCharCode(i.getUint8(e+1))}${String.fromCharCode(i.getUint8(e+2))}${String.fromCharCode(i.getUint8(e+3))}`}(t,e),s.type){case o.COMPOSITE:return await async function(t,e,i,r,s,n){i=C(t,e,i);const o=new DataView(e);for(t.tilesLength=o.getUint32(i,!0),i+=4,t.tiles=[];t.tiles.length<t.tilesLength&&(t.byteLength||0)-i>12;){const o={shape:"tile3d"};t.tiles.push(o),i=await n(e,i,r,s,o)}return i}(s,t,e,i,r,nt);case o.BATCHED_3D_MODEL:return await K(s,t,e,i,r);case o.GLTF:return await async function(t,e,i,r){var s,n;if(t.rotateYtoZ=!0,t.gltfUpAxis=null!=i&&null!==(s=i["3d-tiles"])&&void 0!==s&&s.assetGltfUpAxis?i["3d-tiles"].assetGltfUpAxis:"Y",null!=i&&null!==(n=i["3d-tiles"])&&void 0!==n&&n.loadGLTF){if(!r)return e.byteLength;const s=await(0,c.cr)(e,$.E,i,r);t.gltf=(0,W.w)(s),t.gpuMemoryUsageInBytes=(0,Q.Xr)(t.gltf)}else t.gltfArrayBuffer=e;return e.byteLength}(s,t,i,r);case o.INSTANCED_3D_MODEL:return await st(s,t,e,i,r);case o.POINT_CLOUD:return await j(s,t,e,i,r);default:throw new Error(`3DTileLoader: unknown type ${s.type}`)}}const ot=1952609651,at=1;async function lt(t,e,i,r){const s=Number.isFinite(e.bitstream)?e.bitstream:e.bufferView;if("number"!=typeof s)return;const n=t.bufferViews[s],o=t.buffers[n.buffer];if(null==r||!r.baseUrl)throw new Error("Url is not provided");if(!r.fetch)throw new Error("fetch is not provided");if(o.uri){const t=`${(null==r?void 0:r.baseUrl)||""}/${o.uri}`,i=await r.fetch(t),s=await i.arrayBuffer();return void(e.explicitBitstream=new Uint8Array(s,n.byteOffset,n.byteLength))}const a=t.buffers.slice(0,n.buffer).reduce(((t,e)=>t+e.byteLength),0);e.explicitBitstream=new Uint8Array(i.slice(a,a+o.byteLength),n.byteOffset,n.byteLength)}function ht(t){const e=new DataView(t);return e.getUint32(0,!0)+2**32*e.getUint32(4,!0)}const ct={id:"3d-tiles-subtree",name:"3D Tiles Subtree",module:"3d-tiles",version:n,extensions:["subtree"],mimeTypes:["application/octet-stream"],tests:["subtree"],parse:async function(t,e,i){if(new Uint32Array(t.slice(0,4))[0]!==ot)throw new Error("Wrong subtree file magic number");if(new Uint32Array(t.slice(4,8))[0]!==at)throw new Error("Wrong subtree file verson, must be 1");const r=ht(t.slice(8,16)),s=new Uint8Array(t,24,r),n=new TextDecoder("utf8").decode(s),o=JSON.parse(n),a=ht(t.slice(16,24));let l=new ArrayBuffer(0);if(a&&(l=t.slice(24+r)),await lt(o,o.tileAvailability,l,i),Array.isArray(o.contentAvailability))for(const h of o.contentAvailability)await lt(o,h,l,i);else await lt(o,o.contentAvailability,l,i);return await lt(o,o.childSubtreeAvailability,l,i),o},options:{}};var ut=i(39470),dt=i(52327);globalThis.probe={};const pt=new dt.Z({id:"@probe.gl/log"});var ft=i(26734);const mt=16;function yt(t){"X"===t&&(t="");const e=t.padEnd(mt,"0");return ft.fromString(e,!0,16)}var gt=i(5044);const Tt=3,_t=61,bt=180/Math.PI;function wt(t,e,i){const r=1<<e;return[(t[0]+i[0])/r,(t[1]+i[1])/r]}function vt(t){return t>=.5?1/3*(4*t*t-1):1/3*(1-4*(1-t)*(1-t))}function St(t){return[vt(t[0]),vt(t[1])]}function Et(t,e){let[i,r]=e;switch(t){case 0:return[1,i,r];case 1:return[-i,1,r];case 2:return[-i,-r,1];case 3:return[-1,-r,-i];case 4:return[r,-1,-i];case 5:return[r,i,-1];default:throw new Error("Invalid face")}}function Pt(t){let[e,i,r]=t;const s=Math.atan2(r,Math.sqrt(e*e+i*i));return[Math.atan2(i,e)*bt,s*bt]}function It(t,e,i,r){if(0===r){1===i&&(e[0]=t-1-e[0],e[1]=t-1-e[1]);const r=e[0];e[0]=e[1],e[1]=r}}function At(t){const e=function(t){if(t.indexOf("/")>0)return t;const e=yt(t);return function(t){if(t.isZero())return"";let e=t.toString(2);for(;e.length<Tt+_t;)e="0"+e;const i=e.lastIndexOf("1"),r=e.substring(0,3),s=e.substring(3,i),n=s.length/2,o=ft.fromString(r,!0,2).toString(10);let a="";if(0!==n)for(a=ft.fromString(s,!0,2).toString(4);a.length<n;)a="0"+a;return`${o}/${a}`}(e)}(t);return function(t){if(0===t.length)throw new Error(`Invalid Hilbert quad key ${t}`);const e=t.split("/"),i=parseInt(e[0],10),r=e[1],s=r.length;let n=0;const o=[0,0];for(let a=s-1;a>=0;a--){n=s-a;const t=r[a];let e=0,i=0;"1"===t?i=1:"2"===t?(e=1,i=1):"3"===t&&(e=1);const l=Math.pow(2,n-1);It(l,o,e,i),o[0]+=l*e,o[1]+=l*i}if(i%2==1){const t=o[0];o[0]=o[1],o[1]=t}return{face:i,ij:o,level:n}}(e)}const Ot=100;function Nt(t){const{face:e,ij:i,level:r}=t,s=[[0,0],[0,1],[1,1],[1,0],[0,0]],n=Math.max(1,Math.ceil(Ot*Math.pow(2,-r))),o=new Float64Array(4*n*2+2);let a=0,l=0;for(let h=0;h<4;h++){const t=s[h].slice(0),c=s[h+1],u=(c[0]-t[0])/n,d=(c[1]-t[1])/n;for(let s=0;s<n;s++){t[0]+=u,t[1]+=d;const s=Pt(Et(e,St(wt(i,r,t))));Math.abs(s[1])>89.999&&(s[0]=l);const n=s[0]-l;s[0]+=n>180?-360:n<-180?360:0,o[a++]=s[0],o[a++]=s[1],l=s[0]}}return o[a++]=o[0],o[a++]=o[1],o}function Ct(t){if(t.length%2!=0)throw new Error("Invalid corners");const e=[],i=[];for(let r=0;r<t.length;r+=2)e.push(t[r]),i.push(t[r+1]);return e.sort(((t,e)=>t-e)),i.sort(((t,e)=>t-e)),{west:e[0],east:e[e.length-1],north:i[i.length-1],south:i[0]}}function Mt(t,e){const i=(null==e?void 0:e.minimumHeight)||0,r=(null==e?void 0:e.maximumHeight)||0,s=function(t){let e;if(2===t.face||5===t.face){let i=null,r=0;for(let e=0;e<4;e++){const s=Nt(At(`${t.face}/${e}`));null==i&&(i=new Float64Array(4*s.length)),i.set(s,r),r+=s.length}e=Ct(i)}else e=Ct(Nt(t));return e}(At(t)),n=s.west,o=s.south,a=s.east,l=s.north,h=[];return h.push(new d.P(n,l,i)),h.push(new d.P(a,l,i)),h.push(new d.P(a,o,i)),h.push(new d.P(n,o,i)),h.push(new d.P(n,l,r)),h.push(new d.P(a,l,r)),h.push(new d.P(a,o,r)),h.push(new d.P(n,o,r)),h}function xt(t){return function(t){const e=St(wt(t.ij,t.level,[.5,.5]));return Pt(Et(t.face,e))}(At(t))}function Lt(t){const e=t.token,i={minimumHeight:t.minimumHeight,maximumHeight:t.maximumHeight},r=Mt(e,i),s=xt(e),n=s[0],o=s[1],a=rt.H.WGS84.cartographicToCartesian([n,o,i.maximumHeight]),l=new d.P(a[0],a[1],a[2]);r.push(l);const h=(0,gt.du)(r);return[...h.center,...h.halfAxes]}const Rt={QUADTREE:4,OCTREE:8};function Ut(t,e,i){if(null!=t&&t.box){const r=function(t,e){const i=function(t){return t.and(t.not().add(1))}(t).shiftRightUnsigned(2);return t.add(ft.fromNumber(2*e+1-4).multiply(i))}(yt(t.s2VolumeInfo.token),e),s=function(t){if(t.isZero())return"X";let e=t.countTrailingZeros();e=(e-e%4)/4;const i=e;e*=4;const r=t.shiftRightUnsigned(e).toString(16).replace(/0+$/,"");return Array(17-i-r.length).join("0")+r}(r),n={...t.s2VolumeInfo};if(n.token=s,"OCTREE"===i){const e=t.s2VolumeInfo,i=e.maximumHeight-e.minimumHeight,r=i/2,s=e.minimumHeight+i/2;e.minimumHeight=s-r,e.maximumHeight=s+r}return{box:Lt(n),s2VolumeInfo:n}}}async function Dt(t){const{implicitOptions:e,parentData:i={mortonIndex:0,x:0,y:0,z:0},childIndex:r=0,s2VolumeBox:s,loaderOptions:n}=t;let{subtree:o,level:a=0,globalData:l={level:0,mortonIndex:0,x:0,y:0,z:0}}=t;const{subdivisionScheme:h,subtreeLevels:c,maximumLevel:u,contentUrlTemplate:d,subtreesUriTemplate:p,basePath:f}=e,m={children:[],lodMetricValue:0,contentUrl:""};if(!u)return pt.once(`Missing 'maximumLevel' or 'availableLevels' property. The subtree ${d} won't be loaded...`),m;const y=a+l.level;if(y>u)return m;const g=Rt[h],T=Math.log2(g),_=1&r,b=r>>1&1,w=r>>2&1,v=(g**a-1)/(g-1);let S=Gt(i.mortonIndex,r,T),E=v+S,P=Gt(i.x,_,1),I=Gt(i.y,b,1),A=Gt(i.z,w,1),O=!1;a>=c&&(O=Bt(o.childSubtreeAvailability,S));const N=Gt(l.x,P,a),C=Gt(l.y,I,a),M=Gt(l.z,A,a);if(O){const t=zt(`${f}/${p}`,y,N,C,M);o=await(0,ut.z)(t,ct,n),l={mortonIndex:S,x:P,y:I,z:A,level:a},S=0,E=0,P=0,I=0,A=0,a=0}if(!Bt(o.tileAvailability,E))return m;Bt(o.contentAvailability,E)&&(m.contentUrl=zt(d,y,N,C,M));const x=a+1,L={mortonIndex:S,x:P,y:I,z:A};for(let R=0;R<g;R++){const t=Ut(s,R,h),i=await Dt({subtree:o,implicitOptions:e,loaderOptions:n,parentData:L,childIndex:R,level:x,globalData:{...l},s2VolumeBox:t});if(i.contentUrl||i.children.length){const t=Vt(i,y+1,{childTileX:P,childTileY:I,childTileZ:A},e,s);m.children.push(t)}}return m}function Bt(t,e){let i;return Array.isArray(t)?(i=t[0],t.length>1&&pt.once('Not supported extension "3DTILES_multiple_contents" has been detected')):i=t,"constant"in i?Boolean(i.constant):!!i.explicitBitstream&&function(t,e){const i=Math.floor(t/8),r=t%8;return 1==(e[i]>>r&1)}(e,i.explicitBitstream)}function Vt(t,e,i,r,s){const{basePath:n,refine:o,getRefine:a,lodMetricType:l,getTileType:h,rootLodMetricValue:c,rootBoundingVolume:u}=r,d=t.contentUrl&&t.contentUrl.replace(`${n}/`,""),p=c/2**e,f=function(t,e,i){if(e.region){const{childTileX:r,childTileY:s,childTileZ:n}=i,[o,a,l,h,c,u]=e.region,d=2**t,p=(l-o)/d,f=(h-a)/d,m=(u-c)/d,[y,g]=[o+p*r,o+p*(r+1)],[T,_]=[a+f*s,a+f*(s+1)],[b,w]=[c+m*n,c+m*(n+1)];return{region:[y,T,g,_,b,w]}}if(e.box)return e;throw new Error(`Unsupported bounding volume type ${e}`)}(e,null!=s&&s.box?{box:s.box}:u,i);return{children:t.children,contentUrl:t.contentUrl,content:{uri:d},id:t.contentUrl,refine:a(o),type:h(t),lodMetricType:l,lodMetricValue:p,geometricError:p,transform:t.transform,boundingVolume:f}}function Gt(t,e,i){return(t<<i)+e}function zt(t,e,i,r,s){const n=function(t){const e={};for(const i in t)e[`{${i}}`]=t[i];return e}({level:e,x:i,y:r,z:s});return t.replace(/{level}|{x}|{y}|{z}/gi,(t=>n[t]))}function Ft(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(!e)return s.R7.EMPTY;const i=e.split("?")[0].split(".").pop();switch(i){case"pnts":return s.R7.POINTCLOUD;case"i3dm":case"b3dm":case"glb":case"gltf":return s.R7.SCENEGRAPH;default:return i||s.R7.EMPTY}}function qt(t){switch(t){case"REPLACE":case"replace":return s.F$.REPLACE;case"ADD":case"add":return s.F$.ADD;default:return t}}function Ht(t,e){if(/^[a-z][0-9a-z+.-]*:/i.test(e)){const i=new URL(t,`${e}/`);return decodeURI(i.toString())}return t.startsWith("/")?t:r.DB(e,t)}function kt(t,e){if(!t)return null;let i;if(t.content){var r;const s=t.content.uri||(null===(r=t.content)||void 0===r?void 0:r.url);void 0!==s&&(i=Ht(s,e))}return{...t,id:i,contentUrl:i,lodMetricType:s.ci.GEOMETRIC_ERROR,lodMetricValue:t.geometricError,transformMatrix:t.transform,type:Ft(t,i),refine:qt(t.refine)}}async function jt(t,e,i,r,n){var o,a,l;const{subdivisionScheme:h,maximumLevel:c,availableLevels:u,subtreeLevels:d,subtrees:{uri:p}}=r,f=Ht(zt(p,0,0,0,0),i),m=await(0,ut.z)(f,ct,n),y=null===(o=t.content)||void 0===o?void 0:o.uri,g=y?Ht(y,i):"",T=null==e||null===(a=e.root)||void 0===a?void 0:a.refine,_=t.geometricError,b=null===(l=t.boundingVolume.extensions)||void 0===l?void 0:l["3DTILES_bounding_volume_S2"];if(b){const e={box:Lt(b),s2VolumeInfo:b};t.boundingVolume=e}const w=t.boundingVolume,v={contentUrlTemplate:g,subtreesUriTemplate:p,subdivisionScheme:h,subtreeLevels:d,maximumLevel:Number.isFinite(u)?u-1:c,refine:T,basePath:i,lodMetricType:s.ci.GEOMETRIC_ERROR,rootLodMetricValue:_,rootBoundingVolume:w,getTileType:Ft,getRefine:qt};return await async function(t,e,i,r,n){if(!t)return null;const{children:o,contentUrl:a}=await Dt({subtree:i,implicitOptions:r,loaderOptions:n});let l,h=null;a&&(l=a,h={uri:a.replace(`${e}/`,"")});const c={...t,id:l,contentUrl:l,lodMetricType:s.ci.GEOMETRIC_ERROR,lodMetricValue:t.geometricError,transformMatrix:t.transform,type:Ft(t,l),refine:qt(t.refine),content:h||t.content,children:o};return c}(t,i,m,v,n)}function $t(t){var e;return(null==t||null===(e=t.extensions)||void 0===e?void 0:e["3DTILES_implicit_tiling"])||(null==t?void 0:t.implicitTiling)}const Wt={id:"3d-tiles",name:"3D Tiles",module:"3d-tiles",version:n,extensions:["cmpt","pnts","b3dm","i3dm"],mimeTypes:["application/octet-stream"],tests:["cmpt","pnts","b3dm","i3dm"],parse:async function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0;const n=e["3d-tiles"]||{};let o;o="auto"===n.isTileset?(null==i?void 0:i.url)&&-1!==i.url.indexOf(".json"):n.isTileset;return o?async function(t,e,i){var n;const o=JSON.parse((new TextDecoder).decode(t)),a=(null==i?void 0:i.url)||"",l=function(t){return r.XX(t)}(a),h=await async function(t,e,i){let r=null;const s=$t(t.root);r=s&&t.root?await jt(t.root,t,e,s,i):kt(t.root,e);const n=[];for(n.push(r);n.length>0;){const r=n.pop()||{},s=r.children||[],o=[];for(const a of s){const r=$t(a);let s;s=r?await jt(a,t,e,r,i):kt(a,e),s&&(o.push(s),n.push(s))}r.children=o}return r}(o,l,e||{}),c={...o,shape:"tileset3d",loader:Wt,url:a,queryString:(null==i?void 0:i.queryString)||"",basePath:l,root:h||o.root,type:s.i3.TILES3D,lodMetricType:s.ci.GEOMETRIC_ERROR,lodMetricValue:(null===(n=o.root)||void 0===n?void 0:n.geometricError)||0};return c}(t,e,i):async function(t,e,i){const r={content:{shape:"tile3d",featureIds:null}},s=0;return await nt(t,s,e,i,r.content),r.content}(t,e,i)},options:{"3d-tiles":{loadGLTF:!0,decodeQuantizedPositions:!1,isTileset:"auto",assetGltfUpAxis:null}}}},2634:(t,e,i)=>{i.d(e,{GL:()=>s,I6:()=>r});const r={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DOUBLE:5130},s={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,...r}},61439:(t,e,i)=>{i.d(e,{F$:()=>s,Qb:()=>r,R7:()=>n,ci:()=>a,fB:()=>l,i3:()=>o});const r={UNLOADED:0,LOADING:1,PROCESSING:2,READY:3,EXPIRED:4,FAILED:5};let s=function(t){return t[t.ADD=1]="ADD",t[t.REPLACE=2]="REPLACE",t}({}),n=function(t){return t.EMPTY="empty",t.SCENEGRAPH="scenegraph",t.POINTCLOUD="pointcloud",t.MESH="mesh",t}({}),o=function(t){return t.I3S="I3S",t.TILES3D="TILES3D",t}({}),a=function(t){return t.GEOMETRIC_ERROR="geometricError",t.MAX_SCREEN_THRESHOLD="maxScreenThreshold",t}({});const l={NOT_COMPUTED:-1,USE_OPTIMIZATION:1,SKIP_OPTIMIZATION:0}},15977:(t,e,i)=>{i.d(e,{u:()=>Et});var r=i(84900),s=i(51394),n=i(99313),o=i(95328),a=i(74152),l=i(58853);class h{constructor(t,e,i){this.item=void 0,this.previous=void 0,this.next=void 0,this.item=t,this.previous=e,this.next=i}}class c{constructor(){this.head=null,this.tail=null,this._length=0}get length(){return this._length}add(t){const e=new h(t,this.tail,null);return this.tail?(this.tail.next=e,this.tail=e):(this.head=e,this.tail=e),++this._length,e}remove(t){t&&(t.previous&&t.next?(t.previous.next=t.next,t.next.previous=t.previous):t.previous?(t.previous.next=null,this.tail=t.previous):t.next?(t.next.previous=null,this.head=t.next):(this.head=null,this.tail=null),t.next=null,t.previous=null,--this._length)}splice(t,e){t!==e&&(this.remove(e),this._insert(t,e))}_insert(t,e){const i=t.next;t.next=e,this.tail===t?this.tail=e:i.previous=e,e.next=i,e.previous=t,++this._length}}class u{constructor(){this._list=void 0,this._sentinel=void 0,this._trimTiles=void 0,this._list=new c,this._sentinel=this._list.add("sentinel"),this._trimTiles=!1}reset(){this._list.splice(this._list.tail,this._sentinel)}touch(t){const e=t._cacheNode;e&&this._list.splice(this._sentinel,e)}add(t,e,i){e._cacheNode||(e._cacheNode=this._list.add(e),i&&i(t,e))}unloadTile(t,e,i){const r=e._cacheNode;r&&(this._list.remove(r),e._cacheNode=null,i&&i(t,e))}unloadTiles(t,e){const i=this._trimTiles;this._trimTiles=!1;const r=this._list,s=1024*t.maximumMemoryUsage*1024,n=this._sentinel;let o=r.head;for(;o!==n&&(t.gpuMemoryUsageInBytes>s||i);){const i=o.item;o=o.next,this.unloadTile(t,i,e)}}trim(){this._trimTiles=!0}}var d=i(56709);var p=i(5044);const f=new s.P,m=new s.P,y=new p.Mh([new p.JO,new p.JO,new p.JO,new p.JO,new p.JO,new p.JO]);function g(t,e){const{cameraDirection:i,cameraUp:r,height:o}=t,{metersPerUnit:a}=t.distanceScales,l=_(t,t.center),h=n.H.WGS84.eastNorthUpToFixedFrame(l),c=t.unprojectPosition(t.cameraPosition),u=n.H.WGS84.cartographicToCartesian(c,new s.P),d=new s.P(h.transformAsVector(new s.P(i).scale(a))).normalize(),p=new s.P(h.transformAsVector(new s.P(r).scale(a))).normalize();!function(t){const e=t.getFrustumPlanes(),i=T(e.near,t.cameraPosition),r=_(t,i),s=_(t,t.cameraPosition,m);let n=0;y.planes[n++].fromPointNormal(r,f.copy(r).subtract(s));for(const o in e){if("near"===o)continue;const s=_(t,T(e[o],i,m),m);y.planes[n++].fromPointNormal(s,f.copy(r).subtract(s))}}(t);const g=t.constructor,{longitude:b,latitude:w,width:v,bearing:S,zoom:E}=t;return{camera:{position:u,direction:d,up:p},viewport:t,topDownViewport:new g({longitude:b,latitude:w,height:o,width:v,bearing:S,zoom:E,pitch:0}),height:o,cullingVolume:y,frameNumber:e,sseDenominator:1.15}}function T(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new s.P;const r=t.normal.dot(e);return i.copy(t.normal).scale(t.distance-r).add(e),i}function _(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new s.P;const r=t.unprojectPosition(e);return n.H.WGS84.cartographicToCartesian(r,i)}const b=6378137,w=6378137,v=6356752.314245179,S=new s.P;function E(t,e){if(t instanceof p.F7){const{halfAxes:i}=t,r=function(t){t.getColumn(0,S);const e=t.getColumn(1),i=t.getColumn(2),r=S.add(e).add(i);return r.len()}(i);return Math.log2(v/(r+e[2]))}if(t instanceof p.KM){const{radius:i}=t;return Math.log2(v/(i+e[2]))}if(t.width&&t.height){const{width:e,height:i}=t;return(Math.log2(b/e)+Math.log2(w/i))/2}return 1}function P(t,e,i){n.H.WGS84.cartographicToCartesian([t.xmax,t.ymax,t.zmax],S);const r=Math.sqrt(Math.pow(S[0]-i[0],2)+Math.pow(S[1]-i[1],2)+Math.pow(S[2]-i[2],2));return Math.log2(v/(r+e[2]))}var I=i(39470),A=i(61439),O=i(55715),N=i(72889),C=i(57588);function M(t){return null!=t}const x=new s.P,L=new s.P,R=new s.P,U=new s.P,D=new s.P,B=new s.P,V=new s.P,G=new s.P;function z(t,e,i){if((0,d.h)(t,"3D Tile: boundingVolume must be defined"),t.box)return q(t.box,e,i);if(t.region)return function(t){const[e,i,o,a,l,h]=t,c=n.H.WGS84.cartographicToCartesian([(0,O.RW)(e),(0,O.RW)(a),l],R),u=n.H.WGS84.cartographicToCartesian([(0,O.RW)(o),(0,O.RW)(i),h],U),d=(new s.P).addVectors(c,u).multiplyByScalar(.5);return n.H.WGS84.cartesianToCartographic(d,D),n.H.WGS84.cartographicToCartesian([(0,O.RW)(o),D[1],D[2]],B),n.H.WGS84.cartographicToCartesian([D[0],(0,O.RW)(a),D[2]],V),n.H.WGS84.cartographicToCartesian([D[0],D[1],h],G),q([...d,...B.subtract(d),...V.subtract(d),...G.subtract(d)],new r.y)}(t.region);if(t.sphere)return function(t,e,i){const r=new s.P(t[0],t[1],t[2]);e.transform(r,r);const n=e.getScale(L),o=Math.max(Math.max(n[0],n[1]),n[2]),a=t[3]*o;if(M(i))return i.center=r,i.radius=a,i;return new p.KM(r,a)}(t.sphere,e,i);throw new Error("3D Tile: boundingVolume must contain a sphere, region, or box")}function F(t,e){if(t.box)return function(t){const e=H(),{halfAxes:i}=t,r=new s.P(i.getColumn(0)),n=new s.P(i.getColumn(1)),o=new s.P(i.getColumn(2));for(let s=0;s<2;s++){for(let i=0;i<2;i++){for(let i=0;i<2;i++)x.copy(t.center),x.add(r),x.add(n),x.add(o),k(e,x),o.negate();n.negate()}r.negate()}return e}(e);if(t.region){const[e,i,r,s,n,o]=t.region;return[[(0,O.RW)(e),(0,O.RW)(i),n],[(0,O.RW)(r),(0,O.RW)(s),o]]}if(t.sphere)return function(t){const e=H(),{center:i,radius:r}=t,o=n.H.WGS84.scaleToGeodeticSurface(i,x);let a;a=o?n.H.WGS84.geodeticSurfaceNormal(o):new s.P(0,0,1);let l=new s.P(a[2],-a[1],0);l.len()>0?l.normalize():l=new s.P(0,1,0);const h=l.clone().cross(a);for(const s of[l,h,a]){L.copy(s).scale(r);for(let t=0;t<2;t++)x.copy(i),x.add(L),k(e,x),L.negate()}return e}(e);throw new Error("Unkown boundingVolume type")}function q(t,e,i){const r=new s.P(t[0],t[1],t[2]);e.transform(r,r);let n=[];if(10===t.length){const e=t.slice(3,6),i=new N._;i.fromArray(t,6);const r=new s.P([1,0,0]),o=new s.P([0,1,0]),a=new s.P([0,0,1]);r.transformByQuaternion(i),r.scale(e[0]),o.transformByQuaternion(i),o.scale(e[1]),a.transformByQuaternion(i),a.scale(e[2]),n=[...r.toArray(),...o.toArray(),...a.toArray()]}else n=[...t.slice(3,6),...t.slice(6,9),...t.slice(9,12)];const o=e.transformAsVector(n.slice(0,3)),a=e.transformAsVector(n.slice(3,6)),l=e.transformAsVector(n.slice(6,9)),h=new C.V([o[0],o[1],o[2],a[0],a[1],a[2],l[0],l[1],l[2]]);return M(i)?(i.center=r,i.halfAxes=h,i):new p.F7(r,h)}function H(){return[[1/0,1/0,1/0],[-1/0,-1/0,-1/0]]}function k(t,e){n.H.WGS84.cartesianToCartographic(e,x),t[0][0]=Math.min(t[0][0],x[0]),t[0][1]=Math.min(t[0][1],x[1]),t[0][2]=Math.min(t[0][2],x[2]),t[1][0]=Math.max(t[1][0],x[0]),t[1][1]=Math.max(t[1][1],x[1]),t[1][2]=Math.max(t[1][2],x[2])}new s.P,new s.P,new r.y,new s.P,new s.P,new s.P;function j(t,e){if(t.dynamicScreenSpaceError&&t.dynamicScreenSpaceErrorComputedDensity){const i=t.dynamicScreenSpaceErrorComputedDensity,r=t.dynamicScreenSpaceErrorFactor,s=function(t,e){const i=t*e;return 1-Math.exp(-i*i)}(e,i)*r;return s}return 0}const $=new s.P,W=new s.P,Q=new s.P,Z=new s.P,Y=new s.P,J=new r.y,X=new r.y;function K(t,e){const{topDownViewport:i}=e,r=t.header.mbs[1],s=t.header.mbs[0],o=t.header.mbs[2],a=t.header.mbs[3],l=[...t.boundingVolume.center],h=i.unprojectPosition(i.cameraPosition);n.H.WGS84.cartographicToCartesian(h,$),W.copy($).subtract(l).normalize(),n.H.WGS84.eastNorthUpToFixedFrame(l,J),X.copy(J).invert(),Q.copy($).transform(X);const c=Math.sqrt(Q[0]*Q[0]+Q[1]*Q[1]),u=c*c/Q[2];Z.copy([Q[0],Q[1],u]);const d=Z.transform(J).subtract(l).normalize(),p=W.cross(d).normalize().scale(a).add(l),f=n.H.WGS84.cartesianToCartographic(p),m=i.project([s,r,o]),y=i.project(f);return Y.copy(m).subtract(y).magnitude()}class tt{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this._map=new Map,this._array=void 0,this._length=void 0,this._array=new Array(t),this._length=t}get length(){return this._length}set length(t){this._length=t,t>this._array.length&&(this._array.length=t)}get values(){return this._array}get(t){return(0,d.h)(t<this._array.length),this._array[t]}set(t,e){(0,d.h)(t>=0),t>=this.length&&(this.length=t+1),this._map.has(this._array[t])&&this._map.delete(this._array[t]),this._array[t]=e,this._map.set(e,t)}delete(t){const e=this._map.get(t);e>=0&&(this._array.splice(e,1),this._map.delete(t),this.length--)}peek(){return this._array[this._length-1]}push(t){if(!this._map.has(t)){const e=this.length++;this._array[e]=t,this._map.set(t,e)}}pop(){const t=this._array[--this.length];return this._map.delete(t),t}reserve(t){(0,d.h)(t>=0),t>this._array.length&&(this._array.length=t)}resize(t){(0,d.h)(t>=0),this.length=t}trim(t){null==t&&(t=this.length),this._array.length=t}reset(){this._array=[],this._map=new Map,this._length=0}find(t){return this._map.has(t)}}const et={loadSiblings:!1,skipLevelOfDetail:!1,updateTransforms:!0,onTraversalEnd:()=>{},viewportTraversersMap:{},basePath:""};class it{traversalFinished(t){return!0}constructor(t){this.options=void 0,this.root=null,this.selectedTiles={},this.requestedTiles={},this.emptyTiles={},this.lastUpdate=(new Date).getTime(),this.updateDebounceTime=1e3,this._traversalStack=new tt,this._emptyTraversalStack=new tt,this._frameNumber=null,this.options={...et,...t}}traverse(t,e,i){this.root=t,this.options={...this.options,...i},this.reset(),this.updateTile(t,e),this._frameNumber=e.frameNumber,this.executeTraversal(t,e)}reset(){this.requestedTiles={},this.selectedTiles={},this.emptyTiles={},this._traversalStack.reset(),this._emptyTraversalStack.reset()}executeTraversal(t,e){const i=this._traversalStack;for(t._selectionDepth=1,i.push(t);i.length>0;){const t=i.pop();let r=!1;this.canTraverse(t,e)&&(this.updateChildTiles(t,e),r=this.updateAndPushChildren(t,e,i,t.hasRenderContent?t._selectionDepth+1:t._selectionDepth));const s=t.parent,n=Boolean(!s||s._shouldRefine),o=!r;t.hasRenderContent?t.refine===A.F$.ADD?(this.loadTile(t,e),this.selectTile(t,e)):t.refine===A.F$.REPLACE&&(this.loadTile(t,e),o&&this.selectTile(t,e)):(this.emptyTiles[t.id]=t,this.loadTile(t,e),o&&this.selectTile(t,e)),this.touchTile(t,e),t._shouldRefine=r&&n}const r=(new Date).getTime();(this.traversalFinished(e)||r-this.lastUpdate>this.updateDebounceTime)&&(this.lastUpdate=r,this.options.onTraversalEnd(e))}updateChildTiles(t,e){const i=t.children;for(const r of i)this.updateTile(r,e)}updateAndPushChildren(t,e,i,r){const{loadSiblings:s,skipLevelOfDetail:n}=this.options,o=t.children;o.sort(this.compareDistanceToCamera.bind(this));const a=t.refine===A.F$.REPLACE&&t.hasRenderContent&&!n;let l=!1,h=!0;for(const c of o)if(c._selectionDepth=r,c.isVisibleAndInRequestVolume?(i.find(c)&&i.delete(c),i.push(c),l=!0):(a||s)&&(this.loadTile(c,e),this.touchTile(c,e)),a){let t;if(t=!!c._inRequestVolume&&(c.hasRenderContent?c.contentAvailable:this.executeEmptyTraversal(c,e)),h=h&&t,!h)return!1}return l||(h=!1),h}updateTile(t,e){this.updateTileVisibility(t,e)}selectTile(t,e){this.shouldSelectTile(t)&&(t._selectedFrame=e.frameNumber,this.selectedTiles[t.id]=t)}loadTile(t,e){this.shouldLoadTile(t)&&(t._requestedFrame=e.frameNumber,t._priority=t._getPriority(),this.requestedTiles[t.id]=t)}touchTile(t,e){t.tileset._cache.touch(t),t._touchedFrame=e.frameNumber}canTraverse(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return!!t.hasChildren&&(t.hasTilesetContent?!t.contentExpired:!(!r&&!t.isVisibleAndInRequestVolume)&&this.shouldRefine(t,e,i))}shouldLoadTile(t){return t.hasUnloadedContent||t.contentExpired}shouldSelectTile(t){return t.contentAvailable&&!this.options.skipLevelOfDetail}shouldRefine(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=t._screenSpaceError;return i&&(r=t.getScreenSpaceError(e,!0)),r>t.tileset.memoryAdjustedScreenSpaceError}updateTileVisibility(t,e){const i=[];if(this.options.viewportTraversersMap)for(const r in this.options.viewportTraversersMap){this.options.viewportTraversersMap[r]===e.viewport.id&&i.push(r)}else i.push(e.viewport.id);t.updateVisibility(e,i)}compareDistanceToCamera(t,e){return t._distanceToCamera-e._distanceToCamera}anyChildrenVisible(t,e){let i=!1;for(const r of t.children)r.updateVisibility(e),i=i||r.isVisibleAndInRequestVolume;return i}executeEmptyTraversal(t,e){let i=!0;const r=this._emptyTraversalStack;for(r.push(t);r.length>0;){const t=r.pop(),s=!t.hasRenderContent&&this.canTraverse(t,e,!1,!1),n=!t.hasRenderContent&&0===t.children.length;if(s||t.contentAvailable||n||(i=!1),this.updateTile(t,e),t.isVisibleAndInRequestVolume||(this.loadTile(t,e),this.touchTile(t,e)),s){const e=t.children;for(const t of e)r.push(t)}}return i}}const rt=new s.P;class st{constructor(t,e,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";this.tileset=void 0,this.header=void 0,this.id=void 0,this.url=void 0,this.parent=void 0,this.refine=void 0,this.type=void 0,this.contentUrl=void 0,this.lodMetricType="geometricError",this.lodMetricValue=0,this.boundingVolume=null,this.content=null,this.contentState=A.Qb.UNLOADED,this.gpuMemoryUsageInBytes=0,this.children=[],this.depth=0,this.viewportIds=[],this.transform=new r.y,this.extensions=null,this.implicitTiling=null,this.userData={},this.computedTransform=void 0,this.hasEmptyContent=!1,this.hasTilesetContent=!1,this.traverser=new it({}),this._cacheNode=null,this._frameNumber=null,this._expireDate=null,this._expiredContent=null,this._boundingBox=void 0,this._distanceToCamera=0,this._screenSpaceError=0,this._visibilityPlaneMask=void 0,this._visible=void 0,this._contentBoundingVolume=void 0,this._viewerRequestVolume=void 0,this._initialTransform=new r.y,this._priority=0,this._selectedFrame=0,this._requestedFrame=0,this._selectionDepth=0,this._touchedFrame=0,this._centerZDepth=0,this._shouldRefine=!1,this._stackLength=0,this._visitedFrame=0,this._inRequestVolume=!1,this._lodJudge=null,this.header=e,this.tileset=t,this.id=s||e.id,this.url=e.url,this.parent=i,this.refine=this._getRefine(e.refine),this.type=e.type,this.contentUrl=e.contentUrl,this._initializeLodMetric(e),this._initializeTransforms(e),this._initializeBoundingVolumes(e),this._initializeContent(e),this._initializeRenderingState(e),Object.seal(this)}destroy(){this.header=null}isDestroyed(){return null===this.header}get selected(){return this._selectedFrame===this.tileset._frameNumber}get isVisible(){return this._visible}get isVisibleAndInRequestVolume(){return this._visible&&this._inRequestVolume}get hasRenderContent(){return!this.hasEmptyContent&&!this.hasTilesetContent}get hasChildren(){return this.children.length>0||this.header.children&&this.header.children.length>0}get contentReady(){return this.contentState===A.Qb.READY||this.hasEmptyContent}get contentAvailable(){return Boolean(this.contentReady&&this.hasRenderContent||this._expiredContent&&!this.contentFailed)}get hasUnloadedContent(){return this.hasRenderContent&&this.contentUnloaded}get contentUnloaded(){return this.contentState===A.Qb.UNLOADED}get contentExpired(){return this.contentState===A.Qb.EXPIRED}get contentFailed(){return this.contentState===A.Qb.FAILED}get distanceToCamera(){return this._distanceToCamera}get screenSpaceError(){return this._screenSpaceError}get boundingBox(){return this._boundingBox||(this._boundingBox=F(this.header.boundingVolume,this.boundingVolume)),this._boundingBox}getScreenSpaceError(t,e){switch(this.tileset.type){case A.i3.I3S:return K(this,t);case A.i3.TILES3D:return function(t,e,i){const r=t.tileset,s=t.parent&&t.parent.lodMetricValue||t.lodMetricValue,n=i?s:t.lodMetricValue;if(0===n)return 0;const o=Math.max(t._distanceToCamera,1e-7),{height:a,sseDenominator:l}=e,{viewDistanceScale:h}=r.options;let c=n*a*(h||1)/(o*l);return c-=j(r,o),c}(this,t,e);default:throw new Error("Unsupported tileset type")}}unselect(){this._selectedFrame=0}_getGpuMemoryUsageInBytes(){return this.content.gpuMemoryUsageInBytes||this.content.byteLength||0}_getPriority(){const t=this.tileset._traverser,{skipLevelOfDetail:e}=t.options,i=this.refine===A.F$.ADD||e;if(i&&!this.isVisible&&void 0!==this._visible)return-1;if(this.tileset._frameNumber-this._touchedFrame>=1)return-1;if(this.contentState===A.Qb.UNLOADED)return-1;const r=this.parent,s=r&&(!i||0===this._screenSpaceError||r.hasTilesetContent)?r._screenSpaceError:this._screenSpaceError,n=t.root?t.root._screenSpaceError:0;return Math.max(n-s,0)}async loadContent(){if(this.hasEmptyContent)return!1;if(this.content)return!0;this.contentExpired&&(this._expireDate=null),this.contentState=A.Qb.LOADING;const t=await this.tileset._requestScheduler.scheduleRequest(this.id,this._getPriority.bind(this));if(!t)return this.contentState=A.Qb.UNLOADED,!1;try{const t=this.tileset.getTileUrl(this.contentUrl),e=this.tileset.loader,i={...this.tileset.loadOptions,[e.id]:{...this.tileset.loadOptions[e.id],isTileset:"json"===this.type,...this._getLoaderSpecificOptions(e.id)}};return this.content=await(0,I.z)(t,e,i),this.tileset.options.contentLoader&&await this.tileset.options.contentLoader(this),this._isTileset()&&this.tileset._initializeTileHeaders(this.content,this),this.contentState=A.Qb.READY,this._onContentLoaded(),!0}catch(e){throw this.contentState=A.Qb.FAILED,e}finally{t.done()}}unloadContent(){return this.content&&this.content.destroy&&this.content.destroy(),this.content=null,this.header.content&&this.header.content.destroy&&this.header.content.destroy(),this.header.content=null,this.contentState=A.Qb.UNLOADED,!0}updateVisibility(t,e){if(this._frameNumber===t.frameNumber)return;const i=this.parent,r=i?i._visibilityPlaneMask:p.Mh.MASK_INDETERMINATE;if(this.tileset._traverser.options.updateTransforms){const t=i?i.computedTransform:this.tileset.modelMatrix;this._updateTransform(t)}this._distanceToCamera=this.distanceToTile(t),this._screenSpaceError=this.getScreenSpaceError(t,!1),this._visibilityPlaneMask=this.visibility(t,r),this._visible=this._visibilityPlaneMask!==p.Mh.MASK_OUTSIDE,this._inRequestVolume=this.insideViewerRequestVolume(t),this._frameNumber=t.frameNumber,this.viewportIds=e}visibility(t,e){const{cullingVolume:i}=t,{boundingVolume:r}=this;return i.computeVisibilityWithPlaneMask(r,e)}contentVisibility(){return!0}distanceToTile(t){const e=this.boundingVolume;return Math.sqrt(Math.max(e.distanceSquaredTo(t.camera.position),0))}cameraSpaceZDepth(t){let{camera:e}=t;const i=this.boundingVolume;return rt.subVectors(i.center,e.position),e.direction.dot(rt)}insideViewerRequestVolume(t){const e=this._viewerRequestVolume;return!e||e.distanceSquaredTo(t.camera.position)<=0}updateExpiration(){if(null!=this._expireDate&&this.contentReady&&!this.hasEmptyContent){const t=Date.now();Date.lessThan(this._expireDate,t)&&(this.contentState=A.Qb.EXPIRED,this._expiredContent=this.content)}}get extras(){return this.header.extras}_initializeLodMetric(t){"lodMetricType"in t?this.lodMetricType=t.lodMetricType:(this.lodMetricType=this.parent&&this.parent.lodMetricType||this.tileset.lodMetricType,console.warn("3D Tile: Required prop lodMetricType is undefined. Using parent lodMetricType")),"lodMetricValue"in t?this.lodMetricValue=t.lodMetricValue:(this.lodMetricValue=this.parent&&this.parent.lodMetricValue||this.tileset.lodMetricValue,console.warn("3D Tile: Required prop lodMetricValue is undefined. Using parent lodMetricValue"))}_initializeTransforms(t){this.transform=t.transform?new r.y(t.transform):new r.y;const e=this.parent,i=this.tileset,s=e&&e.computedTransform?e.computedTransform.clone():i.modelMatrix.clone();this.computedTransform=new r.y(s).multiplyRight(this.transform);const n=e&&e._initialTransform?e._initialTransform.clone():new r.y;this._initialTransform=new r.y(n).multiplyRight(this.transform)}_initializeBoundingVolumes(t){this._contentBoundingVolume=null,this._viewerRequestVolume=null,this._updateBoundingVolume(t)}_initializeContent(t){this.content={_tileset:this.tileset,_tile:this},this.hasEmptyContent=!0,this.contentState=A.Qb.UNLOADED,this.hasTilesetContent=!1,t.contentUrl&&(this.content=null,this.hasEmptyContent=!1)}_initializeRenderingState(t){this.depth=t.level||(this.parent?this.parent.depth+1:0),this._shouldRefine=!1,this._distanceToCamera=0,this._centerZDepth=0,this._screenSpaceError=0,this._visibilityPlaneMask=p.Mh.MASK_INDETERMINATE,this._visible=void 0,this._inRequestVolume=!1,this._stackLength=0,this._selectionDepth=0,this._frameNumber=0,this._touchedFrame=0,this._visitedFrame=0,this._selectedFrame=0,this._requestedFrame=0,this._priority=0}_getRefine(t){return t||this.parent&&this.parent.refine||A.F$.REPLACE}_isTileset(){return-1!==this.contentUrl.indexOf(".json")}_onContentLoaded(){switch(this.content&&this.content.type){case"vctr":case"geom":this.tileset._traverser.disableSkipLevelOfDetail=!0}this._isTileset()?this.hasTilesetContent=!0:this.gpuMemoryUsageInBytes=this._getGpuMemoryUsageInBytes()}_updateBoundingVolume(t){this.boundingVolume=z(t.boundingVolume,this.computedTransform,this.boundingVolume);const e=t.content;e&&(e.boundingVolume&&(this._contentBoundingVolume=z(e.boundingVolume,this.computedTransform,this._contentBoundingVolume)),t.viewerRequestVolume&&(this._viewerRequestVolume=z(t.viewerRequestVolume,this.computedTransform,this._viewerRequestVolume)))}_updateTransform(){const t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new r.y).clone().multiplyRight(this.transform);!t.equals(this.computedTransform)&&(this.computedTransform=t,this._updateBoundingVolume(this.header))}_getLoaderSpecificOptions(t){return"i3s"===t?{...this.tileset.options.i3s,_tileOptions:{attributeUrls:this.header.attributeUrls,textureUrl:this.header.textureUrl,textureFormat:this.header.textureFormat,textureLoaderOptions:this.header.textureLoaderOptions,materialDefinition:this.header.materialDefinition,isDracoGeometry:this.header.isDracoGeometry,mbs:this.header.mbs},_tilesetOptions:{store:this.tileset.tileset.store,attributeStorageInfo:this.tileset.tileset.attributeStorageInfo,fields:this.tileset.tileset.fields},isTileHeader:!1}:{assetGltfUpAxis:(e=this.tileset.tileset).asset&&e.asset.gltfUpAxis||"Y"};var e}}class nt extends it{compareDistanceToCamera(t,e){return 0===e._distanceToCamera&&0===t._distanceToCamera?e._centerZDepth-t._centerZDepth:e._distanceToCamera-t._distanceToCamera}updateTileVisibility(t,e){if(super.updateTileVisibility(t,e),!t.isVisibleAndInRequestVolume)return;const i=t.children.length>0;if(t.hasTilesetContent&&i){const i=t.children[0];return this.updateTileVisibility(i,e),void(t._visible=i._visible)}if(this.meetsScreenSpaceErrorEarly(t,e))return void(t._visible=!1);const r=t.refine===A.F$.REPLACE,s=t._optimChildrenWithinParent===A.fB.USE_OPTIMIZATION;r&&s&&i&&!this.anyChildrenVisible(t,e)&&(t._visible=!1)}meetsScreenSpaceErrorEarly(t,e){const{parent:i}=t;return!(!i||i.hasTilesetContent||i.refine!==A.F$.ADD)&&!this.shouldRefine(t,e,!0)}}class ot{constructor(){this.frameNumberMap=new Map}register(t,e){const i=this.frameNumberMap.get(t)||new Map,r=i.get(e)||0;i.set(e,r+1),this.frameNumberMap.set(t,i)}deregister(t,e){const i=this.frameNumberMap.get(t);if(!i)return;const r=i.get(e)||1;i.set(e,r-1)}isZero(t,e){var i;return 0===((null===(i=this.frameNumberMap.get(t))||void 0===i?void 0:i.get(e))||0)}}const at="REQUESTED",lt="COMPLETED",ht="ERROR";class ct{constructor(){this._statusMap=void 0,this.pendingTilesRegister=new ot,this._statusMap={}}add(t,e,i,r){if(!this._statusMap[e]){const{frameNumber:s,viewport:{id:n}}=r;this._statusMap[e]={request:t,callback:i,key:e,frameState:r,status:at},this.pendingTilesRegister.register(n,s),t().then((t=>{this._statusMap[e].status=lt;const{frameNumber:i,viewport:{id:s}}=this._statusMap[e].frameState;this.pendingTilesRegister.deregister(s,i),this._statusMap[e].callback(t,r)})).catch((t=>{this._statusMap[e].status=ht;const{frameNumber:r,viewport:{id:s}}=this._statusMap[e].frameState;this.pendingTilesRegister.deregister(s,r),i(t)}))}}update(t,e){if(this._statusMap[t]){const{frameNumber:i,viewport:{id:r}}=this._statusMap[t].frameState;this.pendingTilesRegister.deregister(r,i);const{frameNumber:s,viewport:{id:n}}=e;this.pendingTilesRegister.register(n,s),this._statusMap[t].frameState=e}}find(t){return this._statusMap[t]}hasPendingTiles(t,e){return!this.pendingTilesRegister.isZero(t,e)}}class ut extends it{constructor(t){super(t),this._tileManager=void 0,this._tileManager=new ct}traversalFinished(t){return!this._tileManager.hasPendingTiles(t.viewport.id,this._frameNumber||0)}shouldRefine(t,e){return t._lodJudge=function(t,e){if(0===t.lodMetricValue||isNaN(t.lodMetricValue))return"DIG";const i=2*K(t,e);return i<2?"OUT":!t.header.children||i<=t.lodMetricValue?"DRAW":t.header.children?"DIG":"OUT"}(t,e),"DIG"===t._lodJudge}updateChildTiles(t,e){const i=t.header.children||[],r=t.children,s=t.tileset;for(const n of i){const i=`${n.id}-${e.viewport.id}`,o=r&&r.find((t=>t.id===i));if(o)o&&this.updateTile(o,e);else{let r=()=>this._loadTile(n.id,s);this._tileManager.find(i)?this._tileManager.update(i,e):(s.tileset.nodePages&&(r=()=>s.tileset.nodePagesTile.formTileFromNodePages(n.id)),this._tileManager.add(r,i,(e=>this._onTileLoad(e,t,i)),e))}}return!1}async _loadTile(t,e){const{loader:i}=e,r=e.getTileUrl(`${e.url}/nodes/${t}`),s={...e.loadOptions,i3s:{...e.loadOptions.i3s,isTileHeader:!0}};return await(0,I.z)(r,i,s)}_onTileLoad(t,e,i){const r=new st(e.tileset,t,e,i);e.children.push(r);const s=this._tileManager.find(r.id).frameState;this.updateTile(r,s),this._frameNumber===s.frameNumber&&(this.traversalFinished(s)||(new Date).getTime()-this.lastUpdate>this.updateDebounceTime)&&this.executeTraversal(r,s)}}const dt={description:"",ellipsoid:n.H.WGS84,modelMatrix:new r.y,throttleRequests:!0,maxRequests:64,maximumMemoryUsage:32,memoryCacheOverflow:1,maximumTilesSelected:0,debounceTime:0,onTileLoad:()=>{},onTileUnload:()=>{},onTileError:()=>{},onTraversalComplete:t=>t,contentLoader:void 0,viewDistanceScale:1,maximumScreenSpaceError:8,memoryAdjustedScreenSpaceError:!1,loadTiles:!0,updateTransforms:!0,viewportTraversersMap:null,loadOptions:{fetch:{}},attributions:[],basePath:"",i3s:{}},pt="Tiles In Tileset(s)",ft="Tiles In Memory",mt="Tiles In View",yt="Tiles To Render",gt="Tiles Loaded",Tt="Tiles Loading",_t="Tiles Unloaded",bt="Failed Tile Loads",wt="Points/Vertices",vt="Tile Memory Use",St="Maximum Screen Space Error";class Et{constructor(t,e){this.options=void 0,this.loadOptions=void 0,this.type=void 0,this.tileset=void 0,this.loader=void 0,this.url=void 0,this.basePath=void 0,this.modelMatrix=void 0,this.ellipsoid=void 0,this.lodMetricType=void 0,this.lodMetricValue=void 0,this.refine=void 0,this.root=null,this.roots={},this.asset={},this.description="",this.properties=void 0,this.extras=null,this.attributions={},this.credits={},this.stats=void 0,this.contentFormats={draco:!1,meshopt:!1,dds:!1,ktx2:!1},this.cartographicCenter=null,this.cartesianCenter=null,this.zoom=1,this.boundingVolume=null,this.dynamicScreenSpaceErrorComputedDensity=0,this.maximumMemoryUsage=32,this.gpuMemoryUsageInBytes=0,this.memoryAdjustedScreenSpaceError=0,this._cacheBytes=0,this._cacheOverflowBytes=0,this._frameNumber=0,this._queryParams={},this._extensionsUsed=[],this._tiles={},this._pendingCount=0,this.selectedTiles=[],this.traverseCounter=0,this.geometricError=0,this.lastUpdatedVieports=null,this._requestedTiles=[],this._emptyTiles=[],this.frameStateData={},this._traverser=void 0,this._cache=new u,this._requestScheduler=void 0,this.updatePromise=null,this.tilesetInitializationPromise=void 0,this.options={...dt,...e},this.tileset=t,this.loader=t.loader,this.type=t.type,this.url=t.url,this.basePath=t.basePath||a.XX(this.url),this.modelMatrix=this.options.modelMatrix,this.ellipsoid=this.options.ellipsoid,this.lodMetricType=t.lodMetricType,this.lodMetricValue=t.lodMetricValue,this.refine=t.root.refine,this.loadOptions=this.options.loadOptions||{},this._traverser=this._initializeTraverser(),this._requestScheduler=new l.Z({throttleRequests:this.options.throttleRequests,maxRequests:this.options.maxRequests}),this.memoryAdjustedScreenSpaceError=this.options.maximumScreenSpaceError,this._cacheBytes=1024*this.options.maximumMemoryUsage*1024,this._cacheOverflowBytes=1024*this.options.memoryCacheOverflow*1024,this.stats=new o.Z({id:this.url}),this._initializeStats(),this.tilesetInitializationPromise=this._initializeTileSet(t)}destroy(){this._destroy()}isLoaded(){return 0===this._pendingCount&&0!==this._frameNumber&&0===this._requestedTiles.length}get tiles(){return Object.values(this._tiles)}get frameNumber(){return this._frameNumber}get queryParams(){return new URLSearchParams(this._queryParams).toString()}setProps(t){this.options={...this.options,...t}}getTileUrl(t){if(t.startsWith("data:"))return t;let e=t;return this.queryParams.length&&(e=`${t}${t.includes("?")?"&":"?"}${this.queryParams}`),e}hasExtension(t){return Boolean(this._extensionsUsed.indexOf(t)>-1)}update(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.tilesetInitializationPromise.then((()=>{!t&&this.lastUpdatedVieports?t=this.lastUpdatedVieports:this.lastUpdatedVieports=t,t&&this.doUpdate(t)}))}async selectTiles(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return await this.tilesetInitializationPromise,t&&(this.lastUpdatedVieports=t),this.updatePromise||(this.updatePromise=new Promise((t=>{setTimeout((()=>{this.lastUpdatedVieports&&this.doUpdate(this.lastUpdatedVieports),t(this._frameNumber),this.updatePromise=null}),this.options.debounceTime)}))),this.updatePromise}adjustScreenSpaceError(){this.gpuMemoryUsageInBytes<this._cacheBytes?this.memoryAdjustedScreenSpaceError=Math.max(this.memoryAdjustedScreenSpaceError/1.02,this.options.maximumScreenSpaceError):this.gpuMemoryUsageInBytes>this._cacheBytes+this._cacheOverflowBytes&&(this.memoryAdjustedScreenSpaceError*=1.02)}doUpdate(t){if("loadTiles"in this.options&&!this.options.loadTiles)return;if(this.traverseCounter>0)return;const e=t instanceof Array?t:[t];this._cache.reset(),this._frameNumber++,this.traverseCounter=e.length;const i=[];for(const r of e){const t=r.id;this._needTraverse(t)?i.push(t):this.traverseCounter--}for(const r of e){const t=r.id;if(this.roots[t]||(this.roots[t]=this._initializeTileHeaders(this.tileset,null)),!i.includes(t))continue;const e=g(r,this._frameNumber);this._traverser.traverse(this.roots[t],e,this.options)}}_needTraverse(t){let e=t;return this.options.viewportTraversersMap&&(e=this.options.viewportTraversersMap[t]),e===t}_onTraversalEnd(t){const e=t.viewport.id;this.frameStateData[e]||(this.frameStateData[e]={selectedTiles:[],_requestedTiles:[],_emptyTiles:[]});const i=this.frameStateData[e],r=Object.values(this._traverser.selectedTiles),[s,n]=function(t,e,i){if(0===i||t.length<=i)return[t,[]];const r=[],{longitude:s,latitude:n}=e.viewport;for(const[h,c]of t.entries()){const[t,e]=c.header.mbs,i=Math.abs(s-t),o=Math.abs(n-e),a=Math.sqrt(o*o+i*i);r.push([h,a])}const o=r.sort(((t,e)=>t[1]-e[1])),a=[];for(let h=0;h<i;h++)a.push(t[o[h][0]]);const l=[];for(let h=i;h<o.length;h++)l.push(t[o[h][0]]);return[a,l]}(r,t,this.options.maximumTilesSelected);i.selectedTiles=s;for(const o of n)o.unselect();i._requestedTiles=Object.values(this._traverser.requestedTiles),i._emptyTiles=Object.values(this._traverser.emptyTiles),this.traverseCounter--,this.traverseCounter>0||this._updateTiles()}_updateTiles(){this.selectedTiles=[],this._requestedTiles=[],this._emptyTiles=[];for(const t in this.frameStateData){const e=this.frameStateData[t];this.selectedTiles=this.selectedTiles.concat(e.selectedTiles),this._requestedTiles=this._requestedTiles.concat(e._requestedTiles),this._emptyTiles=this._emptyTiles.concat(e._emptyTiles)}this.selectedTiles=this.options.onTraversalComplete(this.selectedTiles);for(const t of this.selectedTiles)this._tiles[t.id]=t;this._loadTiles(),this._unloadTiles(),this._updateStats()}_tilesChanged(t,e){if(t.length!==e.length)return!0;const i=new Set(t.map((t=>t.id))),r=new Set(e.map((t=>t.id)));let s=t.filter((t=>!r.has(t.id))).length>0;return s=s||e.filter((t=>!i.has(t.id))).length>0,s}_loadTiles(){for(const t of this._requestedTiles)t.contentUnloaded&&this._loadTile(t)}_unloadTiles(){this._cache.unloadTiles(this,((t,e)=>t._unloadTile(e)))}_updateStats(){let t=0,e=0;for(const i of this.selectedTiles)i.contentAvailable&&i.content&&(t++,i.content.pointCount?e+=i.content.pointCount:e+=i.content.vertexCount);this.stats.get(mt).count=this.selectedTiles.length,this.stats.get(yt).count=t,this.stats.get(wt).count=e,this.stats.get(St).count=this.memoryAdjustedScreenSpaceError}async _initializeTileSet(t){this.type===A.i3.I3S&&(this.calculateViewPropsI3S(),t.root=await t.root),this.root=this._initializeTileHeaders(t,null),this.type===A.i3.TILES3D&&(this._initializeTiles3DTileset(t),this.calculateViewPropsTiles3D()),this.type===A.i3.I3S&&this._initializeI3STileset()}calculateViewPropsI3S(){var t;const e=this.tileset.fullExtent;if(e){const{xmin:t,xmax:i,ymin:r,ymax:o,zmin:a,zmax:l}=e;return this.cartographicCenter=new s.P(t+(i-t)/2,r+(o-r)/2,a+(l-a)/2),this.cartesianCenter=new s.P,n.H.WGS84.cartographicToCartesian(this.cartographicCenter,this.cartesianCenter),void(this.zoom=P(e,this.cartographicCenter,this.cartesianCenter))}const i=null===(t=this.tileset.store)||void 0===t?void 0:t.extent;if(i){const[t,e,r,o]=i;return this.cartographicCenter=new s.P(t+(r-t)/2,e+(o-e)/2,0),this.cartesianCenter=new s.P,n.H.WGS84.cartographicToCartesian(this.cartographicCenter,this.cartesianCenter),void(this.zoom=function(t,e,i){const[r,s,n,o]=t;return P({xmin:r,xmax:n,ymin:s,ymax:o,zmin:0,zmax:0},e,i)}(i,this.cartographicCenter,this.cartesianCenter))}console.warn("Extent is not defined in the tileset header"),this.cartographicCenter=new s.P,this.zoom=1}calculateViewPropsTiles3D(){const t=this.root,{center:e}=t.boundingVolume;if(!e)return console.warn("center was not pre-calculated for the root tile"),this.cartographicCenter=new s.P,void(this.zoom=1);0!==e[0]||0!==e[1]||0!==e[2]?(this.cartographicCenter=new s.P,n.H.WGS84.cartesianToCartographic(e,this.cartographicCenter)):this.cartographicCenter=new s.P(0,0,-n.H.WGS84.radii[0]),this.cartesianCenter=e,this.zoom=E(t.boundingVolume,this.cartographicCenter)}_initializeStats(){this.stats.get(pt),this.stats.get(Tt),this.stats.get(ft),this.stats.get(mt),this.stats.get(yt),this.stats.get(gt),this.stats.get(_t),this.stats.get(bt),this.stats.get(wt),this.stats.get(vt,"memory"),this.stats.get(St)}_initializeTileHeaders(t,e){const i=new st(this,t.root,e);if(e&&(e.children.push(i),i.depth=e.depth+1),this.type===A.i3.TILES3D){const t=[];for(t.push(i);t.length>0;){const e=t.pop();this.stats.get(pt).incrementCount();const i=e.header.children||[];for(const s of i){var r;const i=new st(this,s,e);if(null!==(r=i.contentUrl)&&void 0!==r&&r.includes("?session=")){const t=new URL(i.contentUrl).searchParams.get("session");t&&(this._queryParams.session=t)}e.children.push(i),i.depth=e.depth+1,t.push(i)}}}return i}_initializeTraverser(){let t;switch(this.type){case A.i3.TILES3D:t=nt;break;case A.i3.I3S:t=ut;break;default:t=it}return new t({basePath:this.basePath,onTraversalEnd:this._onTraversalEnd.bind(this)})}_destroyTileHeaders(t){this._destroySubtree(t)}async _loadTile(t){let e;try{this._onStartTileLoading(),e=await t.loadContent()}catch(i){this._onTileLoadError(t,i instanceof Error?i:new Error("load failed"))}finally{this._onEndTileLoading(),this._onTileLoad(t,e)}}_onTileLoadError(t,e){this.stats.get(bt).incrementCount();const i=e.message||e.toString(),r=t.url;console.error(`A 3D tile failed to load: ${t.url} ${i}`),this.options.onTileError(t,i,r)}_onTileLoad(t,e){if(e){if(this.type===A.i3.I3S){var i,o;const t=(null===(i=this.tileset)||void 0===i||null===(o=i.nodePagesTile)||void 0===o?void 0:o.nodesInNodePages)||0;this.stats.get(pt).reset(),this.stats.get(pt).addCount(t)}t&&t.content&&function(t,e){(0,d.h)(t),(0,d.h)(e);const{rtcCenter:i,gltfUpAxis:o}=e,{computedTransform:a,boundingVolume:{center:l}}=t;let h=new r.y(a);switch(i&&h.translate(i),o){case"Z":default:break;case"Y":const t=(new r.y).rotateX(Math.PI/2);h=h.multiplyRight(t);break;case"X":const e=(new r.y).rotateY(-Math.PI/2);h=h.multiplyRight(e)}e.isQuantized&&h.translate(e.quantizedVolumeOffset).scale(e.quantizedVolumeScale);const c=new s.P(l);e.cartesianModelMatrix=h,e.cartesianOrigin=c;const u=n.H.WGS84.cartesianToCartographic(c,new s.P),p=n.H.WGS84.eastNorthUpToFixedFrame(c).invert();e.cartographicModelMatrix=p.multiplyRight(h),e.cartographicOrigin=u,e.coordinateSystem||(e.modelMatrix=e.cartographicModelMatrix)}(t,t.content),this.updateContentTypes(t),this._addTileToCache(t),this.options.onTileLoad(t)}}updateContentTypes(t){if(this.type===A.i3.I3S)switch(t.header.isDracoGeometry&&(this.contentFormats.draco=!0),t.header.textureFormat){case"dds":this.contentFormats.dds=!0;break;case"ktx2":this.contentFormats.ktx2=!0}else if(this.type===A.i3.TILES3D){var e;const{extensionsRemoved:i=[]}=(null===(e=t.content)||void 0===e?void 0:e.gltf)||{};i.includes("KHR_draco_mesh_compression")&&(this.contentFormats.draco=!0),i.includes("EXT_meshopt_compression")&&(this.contentFormats.meshopt=!0),i.includes("KHR_texture_basisu")&&(this.contentFormats.ktx2=!0)}}_onStartTileLoading(){this._pendingCount++,this.stats.get(Tt).incrementCount()}_onEndTileLoading(){this._pendingCount--,this.stats.get(Tt).decrementCount()}_addTileToCache(t){this._cache.add(this,t,(e=>e._updateCacheStats(t)))}_updateCacheStats(t){this.stats.get(gt).incrementCount(),this.stats.get(ft).incrementCount(),this.gpuMemoryUsageInBytes+=t.gpuMemoryUsageInBytes||0,this.stats.get(vt).count=this.gpuMemoryUsageInBytes,this.options.memoryAdjustedScreenSpaceError&&this.adjustScreenSpaceError()}_unloadTile(t){this.gpuMemoryUsageInBytes-=t.gpuMemoryUsageInBytes||0,this.stats.get(ft).decrementCount(),this.stats.get(_t).incrementCount(),this.stats.get(vt).count=this.gpuMemoryUsageInBytes,this.options.onTileUnload(t),t.unloadContent()}_destroy(){const t=[];for(this.root&&t.push(this.root);t.length>0;){const e=t.pop();for(const i of e.children)t.push(i);this._destroyTile(e)}this.root=null}_destroySubtree(t){const e=t,i=[];for(i.push(e);i.length>0;){t=i.pop();for(const e of t.children)i.push(e);t!==e&&this._destroyTile(t)}e.children=[]}_destroyTile(t){this._cache.unloadTile(this,t),this._unloadTile(t),t.destroy()}_initializeTiles3DTileset(t){if(t.queryString){const e=new URLSearchParams(t.queryString),i=Object.fromEntries(e.entries());this._queryParams={...this._queryParams,...i}}if(this.asset=t.asset,!this.asset)throw new Error("Tileset must have an asset property.");if("0.0"!==this.asset.version&&"1.0"!==this.asset.version&&"1.1"!==this.asset.version)throw new Error("The tileset must be 3D Tiles version either 0.0 or 1.0 or 1.1.");"tilesetVersion"in this.asset&&(this._queryParams.v=this.asset.tilesetVersion),this.credits={attributions:this.options.attributions||[]},this.description=this.options.description||"",this.properties=t.properties,this.geometricError=t.geometricError,this._extensionsUsed=t.extensionsUsed||[],this.extras=t.extras}_initializeI3STileset(){this.loadOptions.i3s&&"token"in this.loadOptions.i3s&&(this._queryParams.token=this.loadOptions.i3s.token)}}},72969:(t,e,i)=>{i.d(e,{F:()=>l});var r=i(16915),s=i(55715),n=i(44028),o=i(24621),a=i(35586);class l extends r.O{constructor(t=0,e=0){super(2),(0,s.kJ)(t)&&1===arguments.length?this.copy(t):(s.vc.debug&&((0,n.u5)(t),(0,n.u5)(e)),this[0]=t,this[1]=e)}set(t,e){return this[0]=t,this[1]=e,this.check()}copy(t){return this[0]=t[0],this[1]=t[1],this.check()}fromObject(t){return s.vc.debug&&((0,n.u5)(t.x),(0,n.u5)(t.y)),this[0]=t.x,this[1]=t.y,this.check()}toObject(t){return t.x=this[0],t.y=this[1],t}get ELEMENTS(){return 2}horizontalAngle(){return Math.atan2(this.y,this.x)}verticalAngle(){return Math.atan2(this.x,this.y)}transform(t){return this.transformAsPoint(t)}transformAsPoint(t){return(0,o.fF)(this,this,t),this.check()}transformAsVector(t){return(0,a.pb)(this,this,t),this.check()}transformByMatrix3(t){return(0,o.kK)(this,this,t),this.check()}transformByMatrix2x3(t){return(0,o.iu)(this,this,t),this.check()}transformByMatrix2(t){return(0,o.c)(this,this,t),this.check()}}},99313:(t,e,i)=>{i.d(e,{H:()=>L});var r=i(51394),s=i(82654),n=i(92790),o=i(53015),a=i(84900),l=i(55715);const h=6378137,c=6378137,u=6356752.314245179;Math.max(h,c,u);function d(t){return t}new r.P;function p(t,e=[],i=d){return"longitude"in t?(e[0]=i(t.longitude),e[1]=i(t.latitude),e[2]=t.height):"x"in t?(e[0]=i(t.x),e[1]=i(t.y),e[2]=t.z):(e[0]=i(t[0]),e[1]=i(t[1]),e[2]=t[2]),e}function f(t,e,i=d){return"longitude"in e?(e.longitude=i(t[0]),e.latitude=i(t[1]),e.height=t[2]):"x"in e?(e.x=i(t[0]),e.y=i(t[1]),e.z=t[2]):(e[0]=i(t[0]),e[1]=i(t[1]),e[2]=t[2]),e}const m=1e-14,y=new r.P,g={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}},T={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},_={east:new r.P,north:new r.P,up:new r.P,west:new r.P,south:new r.P,down:new r.P},b=new r.P,w=new r.P,v=new r.P;function S(t,e,i,r,s,o){const a=g[e]&&g[e][i];let h,c,u;(0,n.h)(a&&(!r||r===a));const d=y.copy(s);if((0,l.fS)(d.x,0,m)&&(0,l.fS)(d.y,0,m)){const t=Math.sign(d.z);h=b.fromArray(T[e]),"east"!==e&&"west"!==e&&h.scale(t),c=w.fromArray(T[i]),"east"!==i&&"west"!==i&&c.scale(t),u=v.fromArray(T[r]),"east"!==r&&"west"!==r&&u.scale(t)}else{const{up:s,east:n,north:o}=_;n.set(-d.y,d.x,0).normalize(),t.geodeticSurfaceNormal(d,s),o.copy(s).cross(n);const{down:a,west:l,south:p}=_;a.copy(s).scale(-1),l.copy(n).scale(-1),p.copy(o).scale(-1),h=_[e],c=_[i],u=_[r]}return o[0]=h.x,o[1]=h.y,o[2]=h.z,o[3]=0,o[4]=c.x,o[5]=c.y,o[6]=c.z,o[7]=0,o[8]=u.x,o[9]=u.y,o[10]=u.z,o[11]=0,o[12]=d.x,o[13]=d.y,o[14]=d.z,o[15]=1,o}const E=new r.P,P=new r.P,I=new r.P;const A=new r.P,O=new r.P,N=new r.P,C=new r.P,M=new r.P,x=new r.P;class L{constructor(t=0,e=0,i=0){this.centerToleranceSquared=s.Bs,(0,n.h)(t>=0),(0,n.h)(e>=0),(0,n.h)(i>=0),this.radii=new r.P(t,e,i),this.radiiSquared=new r.P(t*t,e*e,i*i),this.radiiToTheFourth=new r.P(t*t*t*t,e*e*e*e,i*i*i*i),this.oneOverRadii=new r.P(0===t?0:1/t,0===e?0:1/e,0===i?0:1/i),this.oneOverRadiiSquared=new r.P(0===t?0:1/(t*t),0===e?0:1/(e*e),0===i?0:1/(i*i)),this.minimumRadius=Math.min(t,e,i),this.maximumRadius=Math.max(t,e,i),0!==this.radiiSquared.z&&(this.squaredXOverSquaredZ=this.radiiSquared.x/this.radiiSquared.z),Object.freeze(this)}equals(t){return this===t||Boolean(t&&this.radii.equals(t.radii))}toString(){return this.radii.toString()}cartographicToCartesian(t,e=[0,0,0]){const i=O,r=N,[,,s]=t;this.geodeticSurfaceNormalCartographic(t,i),r.copy(this.radiiSquared).scale(i);const n=Math.sqrt(i.dot(r));return r.scale(1/n),i.scale(s),r.add(i),r.to(e)}cartesianToCartographic(t,e=[0,0,0]){x.from(t);const i=this.scaleToGeodeticSurface(x,C);if(!i)return;const r=this.geodeticSurfaceNormal(i,O),s=M;s.copy(x).subtract(i);const n=Math.atan2(r.y,r.x),a=Math.asin(r.z),h=Math.sign(o.AK(s,x))*o.kE(s);return f([n,a,h],e,l.vc._cartographicRadians?d:l.Ux)}eastNorthUpToFixedFrame(t,e=new a.y){return S(this,"east","north","up",t,e)}localFrameToFixedFrame(t,e,i,r,s=new a.y){return S(this,t,e,i,r,s)}geocentricSurfaceNormal(t,e=[0,0,0]){return A.from(t).normalize().to(e)}geodeticSurfaceNormalCartographic(t,e=[0,0,0]){const i=function(t,e=[]){return p(t,e,l.vc._cartographicRadians?d:l.Yr)}(t),r=i[0],s=i[1],n=Math.cos(s);return A.set(n*Math.cos(r),n*Math.sin(r),Math.sin(s)).normalize(),A.to(e)}geodeticSurfaceNormal(t,e=[0,0,0]){return A.from(t).scale(this.oneOverRadiiSquared).normalize().to(e)}scaleToGeodeticSurface(t,e){return function(t,e,i=[]){const{oneOverRadii:r,oneOverRadiiSquared:n,centerToleranceSquared:o}=e;E.from(t);const a=E.x,l=E.y,h=E.z,c=r.x,u=r.y,d=r.z,p=a*a*c*c,f=l*l*u*u,m=h*h*d*d,y=p+f+m,g=Math.sqrt(1/y);if(!Number.isFinite(g))return;const T=P;if(T.copy(t).scale(g),y<o)return T.to(i);const _=n.x,b=n.y,w=n.z,v=I;v.set(T.x*_*2,T.y*b*2,T.z*w*2);let S,A,O,N,C=(1-g)*E.len()/(.5*v.len()),M=0;do{C-=M,S=1/(1+C*_),A=1/(1+C*b),O=1/(1+C*w);const t=S*S,e=A*A,i=O*O;N=p*t+f*e+m*i-1,M=N/(-2*(p*(t*S)*_+f*(e*A)*b+m*(i*O)*w))}while(Math.abs(N)>s.KC);return E.scale([S,A,O]).to(i)}(t,this,e)}scaleToGeocentricSurface(t,e=[0,0,0]){C.from(t);const i=C.x,r=C.y,s=C.z,n=this.oneOverRadiiSquared,o=1/Math.sqrt(i*i*n.x+r*r*n.y+s*s*n.z);return C.multiplyScalar(o).to(e)}transformPositionToScaledSpace(t,e=[0,0,0]){return C.from(t).scale(this.oneOverRadii).to(e)}transformPositionFromScaledSpace(t,e=[0,0,0]){return C.from(t).scale(this.radii).to(e)}getSurfaceNormalIntersectionWithZAxis(t,e=0,i=[0,0,0]){(0,n.h)((0,l.fS)(this.radii.x,this.radii.y,s.H2)),(0,n.h)(this.radii.z>0),C.from(t);const r=C.z*(1-this.squaredXOverSquaredZ);if(!(Math.abs(r)>=this.radii.z-e))return C.set(0,0,r).to(i)}}L.WGS84=new L(h,c,u)}}]);